CREATE PROCEDURE [dbo].[SSP_CompanyDetailList_EntityRelationship]-- '<Json><ServicesAction>LoadAllCompanyDetailListByDropDown</ServicesAction><CompanyType>28</CompanyType><CompanyId>1368</CompanyId></Json>'(@xmlDoc XML)ASBEGINDeclare @sqlTotalCount nvarchar(4000)Declare @sql nvarchar(4000)DECLARE @intPointer INT;DECLARE @whereClause NVARCHAR(max)Declare @PageSize INTDeclare @PageIndex INTDeclare @OrderBy NVARCHAR(20)Declare @CompanyType NVARCHAR(250)Declare @CompanyValue nvarchar(250)Declare @ParentCompany NVARCHAR(250)='0'declare @PrimaryEntity  nvarchar(max) EXEC sp_xml_preparedocument @intpointer OUTPUT,@xmlDocSELECT @PrimaryEntity =tmp.[PrimaryEntity],@CompanyValue=tmp.[CompanyValue]FROM OPENXML(@intpointer,'Json',2)   WITH   (   PrimaryEntity nvarchar(max),   CompanyValue nvarchar(max)     )tmpset  @orderBy =''set  @whereClause =''IF(RTRIM(@orderBy) = '') BEGIN SET @orderBy = 'tmp.[CompanyName]' ENDIF(RTRIM(@whereClause) = '') BEGIN SET @whereClause = '1=1' ENDIF @CompanyValue is  nullBEGIN SET @CompanyValue = '';END SET @sql = 'WITH XMLNAMESPACES(''http://james.newtonking.com/projects/json'' AS json)  select cast ((  select ''true'' AS [@json:Array]  , * from ( SELECT     COUNT(CompanyId) OVER () as TotalCount, [CompanyId] ,[CompanyId] as  [Id]      ,[CompanyName]      ,[CompanyMnemonic]	  ,[CompanyName]+'' (''+ISNULL([CompanyMnemonic],''-'')+'')'' as CompanyNameAndMnemonic	  ,[CompanyName]+'' (''+ISNULL([CompanyMnemonic],''-'')+'')'' as Name	  ,[CompanyType]      	FROM [dbo].Company   where IsActive=1 and (CompanyName like ''%' + @CompanyValue +'%'' or CompanyMnemonic like ''%' + @CompanyValue +'%'')) tmp   WHERE CompanyId in (Select es.RelatedEntity from EntityRelationship es where es.PrimaryEntity='+@PrimaryEntity+' and es.IsActive=1) ORDER BY '+@orderBy+'   FOR XML path(''CompanyList''),ELEMENTS,ROOT(''Json'')) AS XML)'    PRINT @sql --SELECT @ProcessConfiguration as ProcessConfigurationId FOR XML RAW('Json'),ELEMENTS EXEC sp_executesql @sqlEND