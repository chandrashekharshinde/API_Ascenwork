
CREATE PROCEDURE [dbo].[USP_UpdateDPAllData] --'<Json><ServicesAction>UpDateDpAllData</ServicesAction><OrderList><AsnInfos><IntOrderId>400</IntOrderId><OrderNumber>18197953</OrderNumber><EnquiryId>362</EnquiryId><ExpectedTimeOfDelivery>2018-08-03T00:00:00</ExpectedTimeOfDelivery><OrderDate>2018-08-03T03:01:31.96</OrderDate><SoldTo>32</SoldTo><ShipTo>118</ShipTo><ShipToCode>10310013</ShipToCode><ShipToName>Моннидер</ShipToName><PresellerCode /><PresellerName /><SalesmandPhone /><OrderType>SO</OrderType><SalesOrderNumber>18197953</SalesOrderNumber><PreviousState>100</PreviousState><CurrentState>101</CurrentState><DeliveryGroupNumber>011091</DeliveryGroupNumber><CollectionGroupNumber>011090</CollectionGroupNumber><IsCompleted>0</IsCompleted><IsRecievingLocationCapacityExceed>0</IsRecievingLocationCapacityExceed><StockLocationId>7403</StockLocationId><NumberOfPalettes>0.00</NumberOfPalettes><PaymentTerm>1227</PaymentTerm><TruckWeight>0.07</TruckWeight><ReferenceNumber>INQ002187</ReferenceNumber><DiscountAmount>100.00</DiscountAmount><ItemTaxInPec>10</ItemTaxInPec><CompanyName>Моннидер</CompanyName><CompanyMnemonic>10310013</CompanyMnemonic><CreditLimit>465757</CreditLimit><AvailableCreditLimit>7557</AvailableCreditLimit><TaxId>-</TaxId><AR>458200</AR><CustomerAddress>dddddd dddddd dddddd</CustomerAddress><OrderDiscountList><ObjectType>12211221</ObjectType><DiscountAmount>1000.00000</DiscountAmount><DiscountType>2303</DiscountType></OrderDiscountList><OrderDiscountList><ObjectType>12211221</ObjectType><DiscountAmount>10.00000</DiscountAmount><DiscountPercent>1.00</DiscountPercent><DiscountType>2302</DiscountType></OrderDiscountList><IntIsSynced>1</IntIsSynced><IntIsResume>0</IntIsResume></AsnInfos><OrderMovementInfos><OrderMovementId>412</OrderMovementId><OrderId>400</OrderId><OrderNumber>18197953</OrderNumber><TransportOperatorId>21</TransportOperatorId><DeliveryPersonnelId>26</DeliveryPersonnelId><Location>108</Location><LocationType>1</LocationType><VcLocationType>21</VcLocationType><LocationTypeValue>Collection</LocationTypeValue><Action>6000</Action><ExpectedTimeOfAction>2018-08-03T08:00:00</ExpectedTimeOfAction><GroupName>011090</GroupName><IsActive>1</IsActive><CreatedBy>1</CreatedBy><CreatedDate>2018-08-03T03:02:52.333</CreatedDate><DeliveryPersonnelName>DP</DeliveryPersonnelName><DeliveryConactNumber /><LocationAddress>MCS Asia Pacific Brewery LLC</LocationAddress><OrderLocationName>dddddddddddddddddd</OrderLocationName><StartTime>30/8/2018 16:29:54</StartTime><IntIsSynced>1</IntIsSynced><IntIsResume>0</IntIsResume><ActualTimeOfAction>30/8/2018 16:29:55</ActualTimeOfAction></OrderMovementInfos><OrderProductMovementInfos><OrderId>400</OrderId><OrderNumber>18197953</OrderNumber><ProductCode>00280</ProductCode><ItemType>32</ItemType><UnitOfMeasure>Pcs</UnitOfMeasure><PrimaryUnitOfMeasure>13</PrimaryUnitOfMeasure><OrderProductId>838</OrderProductId><IntOrderProductId>838</IntOrderProductId><OrderMovementId>412</OrderMovementId><LocationType>1</LocationType><GroupName>011090</GroupName><PlannedQuantity>6.000000</PlannedQuantity><IsDeliveredAll>1</IsDeliveredAll><VcLocationType>1</VcLocationType><IsSIExist>1</IsSIExist><GradeSequence>0</GradeSequence><ProductLotInfo><OrderId>402</OrderId><OrderProductId>842</OrderProductId><ProductCode>00280</ProductCode><LotNumber>20180209001</LotNumber><Quantity>14.00</Quantity><CollectedQuantity>14</CollectedQuantity><DeliveredQuantity>0.00</DeliveredQuantity></ProductLotInfo><DeliveryStartTime>30/8/2018 16:29:54</DeliveryStartTime><IntIsSynced>1</IntIsSynced><IntIsResume>0</IntIsResume><ActualQuantity>6.000000</ActualQuantity><DeliveryEndTime>30/8/2018 16:29:55</DeliveryEndTime></OrderProductMovementInfos><OrderProductMovementInfos><OrderId>400</OrderId><OrderNumber>18197953</OrderNumber><ProductCode>00254</ProductCode><ItemType>32</ItemType><UnitOfMeasure>Pcs</UnitOfMeasure><PrimaryUnitOfMeasure>13</PrimaryUnitOfMeasure><OrderProductId>839</OrderProductId><IntOrderProductId>839</IntOrderProductId><OrderMovementId>412</OrderMovementId><LocationType>1</LocationType><GroupName>011090</GroupName><PlannedQuantity>2.000000</PlannedQuantity><IsDeliveredAll>1</IsDeliveredAll><VcLocationType>1</VcLocationType><IsSIExist>1</IsSIExist><GradeSequence>0</GradeSequence><ProductLotInfo><OrderId>402</OrderId><OrderProductId>843</OrderProductId><ProductCode>00254</ProductCode><LotNumber>201807270018</LotNumber><Quantity>3.00</Quantity><CollectedQuantity>3</CollectedQuantity><DeliveredQuantity>0.00</DeliveredQuantity></ProductLotInfo><ProductLotInfo><OrderId>402</OrderId><OrderProductId>843</OrderProductId><ProductCode>00254</ProductCode><LotNumber>454270018</LotNumber><Quantity>12.00</Quantity><CollectedQuantity>12</CollectedQuantity><DeliveredQuantity>0.00</DeliveredQuantity></ProductLotInfo><DeliveryStartTime>30/8/2018 16:29:54</DeliveryStartTime><IntIsSynced>1</IntIsSynced><IntIsResume>0</IntIsResume><ActualQuantity>2.000000</ActualQuantity><DeliveryEndTime>30/8/2018 16:29:55</DeliveryEndTime></OrderProductMovementInfos><OrderProductMovementInfos><OrderId>400</OrderId><OrderNumber>18197953</OrderNumber><ProductCode>00280</ProductCode><ItemType>32</ItemType><UnitOfMeasure>Pcs</UnitOfMeasure><PrimaryUnitOfMeasure>13</PrimaryUnitOfMeasure><OrderProductId>838</OrderProductId><IntOrderProductId>838</IntOrderProductId><OrderMovementId>414</OrderMovementId><LocationType>2</LocationType><GroupName>011091</GroupName><PlannedQuantity>6.000000</PlannedQuantity><IsDeliveredAll>0</IsDeliveredAll><VcLocationType>2</VcLocationType><IsSIExist>1</IsSIExist><GradeSequence>0</GradeSequence><ProductLotInfo><OrderId>402</OrderId><OrderProductId>842</OrderProductId><ProductCode>00280</ProductCode><LotNumber>20180209001</LotNumber><Quantity>14.00</Quantity><CollectedQuantity>14</CollectedQuantity><DeliveredQuantity>0.00</DeliveredQuantity></ProductLotInfo><IntIsSynced>1</IntIsSynced><IntIsResume>0</IntIsResume></OrderProductMovementInfos><OrderProductMovementInfos><OrderId>400</OrderId><OrderNumber>18197953</OrderNumber><ProductCode>00254</ProductCode><ItemType>32</ItemType><UnitOfMeasure>Pcs</UnitOfMeasure><PrimaryUnitOfMeasure>13</PrimaryUnitOfMeasure><OrderProductId>839</OrderProductId><IntOrderProductId>839</IntOrderProductId><OrderMovementId>414</OrderMovementId><LocationType>2</LocationType><GroupName>011091</GroupName><PlannedQuantity>2.000000</PlannedQuantity><IsDeliveredAll>0</IsDeliveredAll><VcLocationType>2</VcLocationType><IsSIExist>1</IsSIExist><GradeSequence>0</GradeSequence><ProductLotInfo><OrderId>402</OrderId><OrderProductId>843</OrderProductId><ProductCode>00254</ProductCode><LotNumber>201807270018</LotNumber><Quantity>3.00</Quantity><CollectedQuantity>3</CollectedQuantity><DeliveredQuantity>0.00</DeliveredQuantity></ProductLotInfo><ProductLotInfo><OrderId>402</OrderId><OrderProductId>843</OrderProductId><ProductCode>00254</ProductCode><LotNumber>454270018</LotNumber><Quantity>12.00</Quantity><CollectedQuantity>12</CollectedQuantity><DeliveredQuantity>0.00</DeliveredQuantity></ProductLotInfo><IntIsSynced>1</IntIsSynced><IntIsResume>0</IntIsResume></OrderProductMovementInfos><IsPendingSynced></IsPendingSynced><VcToken>95FE0CE3-1A07-4208-ADD7-44567A5E3D99</VcToken><OrderProductLotDetailsJson><OrderId>402</OrderId><OrderProductId>842</OrderProductId><LotNumber>20180209001</LotNumber><ProductCode>00280</ProductCode><CollectedQuantity>14</CollectedQuantity><DeliveredQuantity>0</DeliveredQuantity><IntIsSynced>1</IntIsSynced></OrderProductLotDetailsJson><OrderProductLotDetailsJson><OrderId>402</OrderId><OrderProductId>843</OrderProductId><LotNumber>201807270018</LotNumber><ProductCode>00254</ProductCode><CollectedQuantity>3</CollectedQuantity><DeliveredQuantity>0</DeliveredQuantity><IntIsSynced>1</IntIsSynced></OrderProductLotDetailsJson><OrderProductLotDetailsJson><OrderId>402</OrderId><OrderProductId>843</OrderProductId><LotNumber>454270018</LotNumber><ProductCode>00254</ProductCode><CollectedQuantity>12</CollectedQuantity><DeliveredQuantity>0</DeliveredQuantity><IntIsSynced>1</IntIsSynced></OrderProductLotDetailsJson><IntOrderId>400</IntOrderId></OrderList></Json>'

@xmlDoc xml

AS
BEGIN 
	SET ARITHABORT ON 
	DECLARE @TranName NVARCHAR(255)
	DECLARE @ErrMsg NVARCHAR(2048)
	DECLARE @ErrSeverity INT;
	DECLARE @intPointer INT;
	SET @ErrSeverity = 15; 

	BEGIN TRY

			EXEC sp_xml_preparedocument @intpointer OUTPUT,@xmlDoc

            DECLARE @orderId bigint
			DECLARE @currentState bigint
			DECLARE @OrderNumber nvarchar(500)

            UPDATE dbo.[Order] SET
			@orderId=tmp.IntOrderId,
			@OrderNumber=tmp.[OrderNumber],
			@currentState=tmp.CurrentState,
        	[PreviousState] = tmp.PreviousState,
        	[CurrentState] = tmp.CurrentState,
		   	[ExpectedTimeOfDelivery]=tmp.ExpectedTimeOfDelivery,  
			[PaymentTerm] = tmp.PaymentTerm,
        	[ModifiedBy]=1 ,
        	[ModifiedDate]=GETDATE()
        	
            FROM OPENXML(@intpointer,'Json/OrderList/AsnInfos',2)
			WITH
			(
			[IntOrderId] bigint,
			[OrderNumber]  nvarchar(500),   
            [RequestDate] nvarchar(500),
            [PrimaryAddress] nvarchar(500),
            [SecondaryAddress] nvarchar(500),
            [OrderProposedETD] nvarchar(500),
			[ExpectedTimeOfDelivery] nvarchar(500),
            [Remarks] nvarchar,
            [PreviousState] bigint,
            [CurrentState] bigint,
			[TruckSizeId] BIGINT,
			[ShipTo] BIGINT,
			[SoldTo] BIGINT,
			[PalletSpace] decimal(18,2),
            [NumberOfPalettes] decimal(18,2),
			[TruckWeight]  decimal(18,2), 
			[PaymentTerm]   bigint,
            [IsActive] bit,
            [SequenceNo] bigint,
			[IsRecievingLocationCapacityExceed] bit,            
			[ModifiedBy] bigint,
			[ModifiedDate] datetime
            )tmp WHERE [Order].OrderId=tmp.[IntOrderId]

				print 'ddd1'
		  print  @orderId
		 print  @OrderNumber
				

			SELECT * INTO #tmpOrderProduct
			FROM OPENXML(@intpointer,'Json/OrderList/OrderProductInfos',2)
			 WITH
             (
			[OrderProductId] BIGINT,
			[ProductCode] nvarchar(200),			        
			[ProductType] nvarchar(200),			
			[Quantity] decimal(10, 2),
			[ShippableQuantity] decimal(10,2),
			[Remarks] nvarchar,
            [DepositeAmountPerUnit] decimal(10,2),
			[ItemPricesPerUnit] decimal(10, 2),
			[UnitPrice] decimal(10, 2),
			[ItemType] bigint,
            [IsActive] bit,
			[ReasonCodeId] bigint,
            [SequenceNo] bigint,
			[AssociatedOrder] nvarchar(100),
			[OrderProductGuid] nvarchar(350),
            [Field1] nvarchar(500),
            [Field2] nvarchar(500),
            [Field3] nvarchar(500),
            [Field4] nvarchar(500),
            [Field5] nvarchar(500),
            [Field6] nvarchar(500),
            [Field7] nvarchar(500),
            [Field8] nvarchar(500),
            [Field9] nvarchar(500),
            [Field10] nvarchar(500)
			 ) tmp

			
			SELECT * INTO #tmpLoseAssetsProductJson
			FROM OPENXML(@intpointer,'Json/OrderList/LoseAssetsProductJson',2)
			 WITH
             (
			[PlanNumber] nvarchar(200),
			[ProductCode] nvarchar(200),			        
			[Location] nvarchar(200),			
			[ProductQuantity] decimal(10, 2)
			)tmp


			INSERT INTO [dbo].[LoseAssetsInRun]
           ([PlanNumber]
           ,[Location]
           ,[ProductCode]
           ,[ProductQuantity]
           ,[CreatedBy]
           ,[CreatedDate]
           ,[IsActive]
           )
		   SELECT tmplar.[PlanNumber]
           ,tmplar.[Location]
           ,tmplar.[ProductCode]
           ,tmplar.[ProductQuantity]
           ,1
           ,GETDATE()
           ,1 from #tmpLoseAssetsProductJson tmplar 
		   Where
		   (Select Count(*) from [dbo].[LoseAssetsInRun] lar where tmplar.[PlanNumber]=lar.[PlanNumber] 
		   and  tmplar.[Location]=lar.[Location] 
		   and  tmplar.[ProductCode]=lar.[ProductCode] )=0

	---------------------------------------------------------If Only Lose Item-----------------------------------------------------------------
	SELECT * INTO #tmpOnlyLoseAssetsProductJson
			FROM OPENXML(@intpointer,'Json/LoseAssetsProductJson',2)
			 WITH
             (
			[PlanNumber] nvarchar(200),
			[ProductCode] nvarchar(200),			        
			[Location] nvarchar(200),			
			[ProductQuantity] decimal(10, 2)
			)tmp


			INSERT INTO [dbo].[LoseAssetsInRun]
           ([PlanNumber]
           ,[Location]
           ,[ProductCode]
           ,[ProductQuantity]
           ,[CreatedBy]
           ,[CreatedDate]
           ,[IsActive]
           )
		   SELECT tmplar.[PlanNumber]
           ,tmplar.[Location]
           ,tmplar.[ProductCode]
           ,tmplar.[ProductQuantity]
           ,1
           ,GETDATE()
           ,1 from #tmpOnlyLoseAssetsProductJson tmplar 
		   Where
		   (Select Count(*) from [dbo].[LoseAssetsInRun] lar where tmplar.[PlanNumber]=lar.[PlanNumber] 
		   and  tmplar.[Location]=lar.[Location] 
		   and  tmplar.[ProductCode]=lar.[ProductCode] )=0
	--------------------------------------------------------------------------------------------------------------------------------------------

	------------------------------------------------------------------ReplacmentProduct----------------------------------------------------------
	 SELECT * INTO #tmpOrderReplacementProductInfos
			FROM OPENXML(@intpointer,'Json/OrderList/OrderReplacementProductInfos',2)
			 WITH
             (
	[ReplacementProductId] bigint,
	[OrderId] bigint,
	[OrderNumber] nvarchar(50) ,
	[ProductCode] nvarchar(50),
	[ItemType] bigint,
	[UnitOfMeasure] nvarchar(50),
	[PrimaryUnitOfMeasure] nvarchar(50),
	[OrderProductId] bigint,
	[OrderMovementId] bigint,
	[PlannedQuantity] decimal(18, 2) ,
	[ActualQuantity] decimal(18, 2) ,
	[GroupName] nvarchar(50),
	[IsActive] bit
	)tmp


	--INSERT INTO [dbo].[ReplacementProduct]
 --          ([OrderId]
 --          ,[OrderNumber]
 --          ,[ProductCode]
 --          ,[ItemType]
 --          ,[UnitOfMeasure]
 --          ,[PrimaryUnitOfMeasure]
 --          ,[OrderProductId]
 --          ,[OrderMovementId]
 --          ,[PlannedQuantity]
 --          ,[ActualQuantity]
 --          ,[GroupName]
 --          ,[IsActive])
 --          Select [OrderId]
 --          ,[OrderNumber]
 --          ,[ProductCode]
 --          ,[ItemType]
 --          ,[UnitOfMeasure]
 --          ,[PrimaryUnitOfMeasure]
 --          ,[OrderProductId]
 --          ,[OrderMovementId]
 --          ,[PlannedQuantity]
 --          ,[ActualQuantity]
 --          ,[GroupName]
 --          ,1 from #tmpOrderReplacementProductInfos trp
	--	    Where
	--	   (Select Count(*) from [dbo].[ReplacementProduct] rp where trp.[OrderId]=rp.[OrderId] 
	--	   and trp.[ProductCode]=rp.[ProductCode] )=0 


	--------------------------------------------------------------------------------------------------------------------------------------------


			UPDATE dbo.OrderProduct
			SET dbo.OrderProduct.[ProductQuantity]=#tmpOrderProduct.[Quantity]
			   ,dbo.OrderProduct.[ShippableQuantity]=#tmpOrderProduct.[Quantity]
			FROM #tmpOrderProduct  
			WHERE dbo.OrderProduct.OrderProductId=#tmpOrderProduct.OrderProductId
			and dbo.OrderProduct.OrderId=@orderId

			UPDATE dbo.OrderProduct
			SET dbo.OrderProduct.[ProductQuantity]=#tmpOrderProduct.[Quantity]
			   ,dbo.OrderProduct.[ShippableQuantity]=#tmpOrderProduct.[Quantity]
			FROM #tmpOrderProduct  
			WHERE dbo.OrderProduct.OrderProductGuid=#tmpOrderProduct.OrderProductGuid
			and dbo.OrderProduct.OrderId=@orderId

			
			INSERT INTO [dbo].[OrderProduct]
           ([OrderId]
           ,[ProductCode]
           ,[ProductType]
           ,[ProductQuantity]
           ,[ShippableQuantity]
		   ,[UnitPrice]
           ,[ItemType]
           ,[IsActive]
           ,[CreatedBy]
           ,[CreatedDate]
		   ,OrderProductGuid          
          ) select  @orderId,
					#tmpOrderProduct.ProductCode,
					9,
					#tmpOrderProduct.Quantity,
					#tmpOrderProduct.Quantity,
					#tmpOrderProduct.UnitPrice,
					#tmpOrderProduct.ItemType,
					1,
					1,
					GETDATE(),
					#tmpOrderProduct.OrderProductGuid
			from #tmpOrderProduct  
			where  #tmpOrderProduct.OrderProductId = 0 and #tmpOrderProduct.OrderProductGuid is not null
		    and #tmpOrderProduct.OrderProductGuid not in (select OrderProductGuid from OrderProduct where OrderId = @orderId and OrderProductGuid is not null)


				print '[OrderProduct] insert'

			 SELECT * INTO #tmpOrderProductInfos
			FROM OPENXML(@intpointer,'Json/OrderList/OrderProductMovementInfos',2)
			 WITH
             (
			[OrderId] bigint,
			[OrderProductMovementId] bigint,
			[OrderNumber] nvarchar(500),
			[OrderProductId] bigint,
			[OrderMovementId] bigint,
			[LocationType] bigint ,
			[DeliveryStartTime]  nvarchar(500),
			[DeliveryEndTime]  nvarchar(500),
			[PlannedQuantity] float ,
			[ActualQuantity] float,
			[OMLotNumber]  nvarchar(50),
			[IsDeliveredAll] bit,
			[OrderProductMovementGuid] nvarchar(350),
			[OrderProductGuid] nvarchar(350)
			 ) tmp

			print '[OrderProduct] insert  2'

			UPDATE dbo.OrderProductMovement
			SET dbo.OrderProductMovement.[ActualQuantity]=#tmpOrderProductInfos.[ActualQuantity]
			,dbo.OrderProductMovement.PlannedQuantity=#tmpOrderProductInfos.PlannedQuantity
			,dbo.OrderProductMovement.DeliveryStartTime=CONVERT(datetime,#tmpOrderProductInfos.DeliveryStartTime, 103 ) 
			,dbo.OrderProductMovement.DeliveryEndTime = CONVERT(datetime,#tmpOrderProductInfos.DeliveryEndTime,103 ) 
			,dbo.OrderProductMovement.IsDeliveredAll=#tmpOrderProductInfos.IsDeliveredAll
			FROM #tmpOrderProductInfos  
			WHERE dbo.OrderProductMovement.OrderProductId=#tmpOrderProductInfos.OrderProductId
			and dbo.OrderProductMovement.OrderMovementId=#tmpOrderProductInfos.OrderMovementId
			and dbo.OrderProductMovement.OMLotNumber=#tmpOrderProductInfos.OMLotNumber
			and dbo.OrderProductMovement.OrderId=@orderId

			--UPDATE dbo.OrderProductMovement
			--SET dbo.OrderProductMovement.[ActualQuantity]=#tmpOrderProductInfos.[ActualQuantity]
			--,dbo.OrderProductMovement.PlannedQuantity=#tmpOrderProductInfos.PlannedQuantity
			--,dbo.OrderProductMovement.DeliveryStartTime=CONVERT(datetime,#tmpOrderProductInfos.DeliveryStartTime, 103 ) 
			--,dbo.OrderProductMovement.DeliveryEndTime = CONVERT(datetime,#tmpOrderProductInfos.DeliveryEndTime,103 ) 
			--,dbo.OrderProductMovement.IsDeliveredAll=#tmpOrderProductInfos.IsDeliveredAll
			--FROM #tmpOrderProductInfos  
			--WHERE dbo.OrderProductMovement.OrderProductMovementGuid=#tmpOrderProductInfos.OrderProductMovementGuid
			--and dbo.OrderProductMovement.OrderId=@orderId


			INSERT INTO [dbo].OrderProductMovement
           ([OrderId]
           ,OrderProductId
           ,OrderMovementId
           ,PlannedQuantity
           ,ActualQuantity
           ,DeliveryStartTime
           ,DeliveryEndTime
           ,[IsDeliveredAll]
           ,[IsActive]
           ,[CreatedBy]
		   ,[CreatedDate]
		   ,[OrderProductMovementGuid]          
          ) select  @orderId,
			(select top 1 OrderProductId from OrderProduct where OrderProductGuid = #tmpOrderProductInfos.OrderProductGuid),
					#tmpOrderProductInfos.OrderMovementId,
					#tmpOrderProductInfos.PlannedQuantity,
					#tmpOrderProductInfos.ActualQuantity,
					CONVERT(datetime,#tmpOrderProductInfos.DeliveryStartTime, 103),
					CONVERT(datetime,#tmpOrderProductInfos.DeliveryEndTime,103) ,
					#tmpOrderProductInfos.IsDeliveredAll,
					1,
					1,
					GETDATE(),
					#tmpOrderProductInfos.OrderProductMovementGuid

			from #tmpOrderProductInfos  
			where  #tmpOrderProductInfos.OrderProductMovementId = 0 and #tmpOrderProductInfos.OrderProductMovementGuid is not null
		    and #tmpOrderProductInfos.OrderProductMovementGuid not in (select OrderProductMovementGuid from OrderProductMovement where OrderId = @orderId and OrderProductMovementGuid is not null)






			  SELECT * INTO #tmpOrderMovementInfos
			FROM OPENXML(@intpointer,'Json/OrderList/OrderMovementInfos',2)
			 WITH
             (
				[OrderMovementId] bigint,
				[OrderId] bigint,
				[TransportOperatorId] bigint,
				[DeliveryPersonnelId] bigint,
				[Location] bigint,
				[LocationType] bigint,
				[Action] int,
				[State] bigint,
				[StartTime] nvarchar(500),
				[PraposedTimeOfAction] nvarchar(500),
				[PraposedShift] nvarchar(500),
				[ExpectedTimeOfAction] nvarchar(50),
				[ExpectedShift] nvarchar(50),
				[ActualTimeOfAction] nvarchar(500),
				[Latitude] nvarchar(50),
				[Longitude] nvarchar(50),
				[GroupName] nvarchar(50),
				[GroupRouteCode] nvarchar(50),
				[IsActive] bit,
				[CreatedBy] bigint,
				[CreatedDate]  nvarchar(50),
				[UpdateBy]  nvarchar(50),
				[UpdatedDate]  nvarchar(50)
			 ) tmp
        	


			UPDATE dbo.OrderMovement
			SET 
			dbo.OrderMovement.ActualTimeOfAction= CONVERT(datetime,#tmpOrderMovementInfos.[ActualTimeOfAction], 103 ) 
			FROM #tmpOrderMovementInfos  
			WHERE dbo.OrderMovement.DeliveryPersonnelId=#tmpOrderMovementInfos.DeliveryPersonnelId
			and dbo.OrderMovement.OrderId=@orderId and OrderMovement.OrderMovementId = #tmpOrderMovementInfos.OrderMovementId
			and dbo.OrderMovement.LocationType=#tmpOrderMovementInfos.LocationType

			print 'OrderMovement update'
			SELECT * INTO #tmpOrderProductLotDetails
			FROM OPENXML(@intpointer,'Json/OrderList/OrderProductLotDetailsJson',2)
			 WITH
             (
				[OrderId] nvarchar(50),
				[OrderProductId] nvarchar(50),
				[LotNumber] nvarchar(50) ,
				[ProductCode] nvarchar(50),
				[CollectedQuantity] decimal(18, 6),
				[DeliveredQuantity] decimal(18, 6)				
			 ) tmp


			 	print 'OrderMovement update 2'
			 update OrderProduct set 
			 CollectedQuantity = #tmpOrderProductLotDetails.[CollectedQuantity],
			 DeliveredQuantity = #tmpOrderProductLotDetails.[DeliveredQuantity]
			 From #tmpOrderProductLotDetails
			 where 
				 OrderProduct.OrderId = #tmpOrderProductLotDetails.OrderId
			 and OrderProduct.ProductCode = #tmpOrderProductLotDetails.ProductCode
			 --and OrderProduct.LotNumber = #tmpOrderProductLotDetails.LotNumber
			 and OrderProduct.OrderProductId = #tmpOrderProductLotDetails.OrderProductId
			 --and OrderProduct.IsPartialShip is null 
			 and  ISNULL(OrderProduct.DeliveredQuantity,0) =0
			
					SELECT * INTO #tmpOrderProductLotInfos
					FROM OPENXML(@intpointer,'Json/OrderList/OrderProductLotInfos',2)
						 WITH
						 (
							[OrderId] nvarchar(50),
							[OrderProductId] nvarchar(50),
							[LotNumber] nvarchar(50) ,
							[ProductCode] nvarchar(50),
							[Quantity] float,
							[CollectedQuantity] float,
							[DeliveredQuantity] float,
							[OrderProductLotGuId] nvarchar(150),
							[OrderProductGuid]	nvarchar(150)		
						 ) tmp


						 print 'OrderMovement update 3'

						UPDATE dbo.OrderProduct
						SET dbo.OrderProduct.[CollectedQuantity]=#tmpOrderProductLotInfos.[CollectedQuantity],
							dbo.OrderProduct.[DeliveredQuantity]=#tmpOrderProductLotInfos.[DeliveredQuantity]
							--,dbo.OrderProduct.[Quantity]=#tmpOrderProductLotInfos.[Quantity]
						FROM #tmpOrderProductLotInfos  
						WHERE OrderProduct.ProductCode = #tmpOrderProductLotInfos.ProductCode
						and OrderProduct.LotNumber = #tmpOrderProductLotInfos.LotNumber
						and OrderProduct.OrderProductGuId = #tmpOrderProductLotInfos.OrderProductLotGuId
						and OrderProduct.OrderId=@orderId 
						and ISNULL(OrderProduct.DeliveredQuantity,0) !=0


							 print 'OrderMovement update 4'

						--INSERT INTO [dbo].OrderProductLotDetails
					 --  ([OrderId]
					 --  ,[OrderProductId]
					 --  ,[ProductCode]
					 --  ,[LotNumber]
					 --  ,[Quantity]
					 --  ,[CollectedQuantity]
					 --  ,[DeliveredQuantity]
					 --  ,[OrderProductLotGuId]
					 --  ,IsDelivered)
						--select #tmpOrderProductLotInfos.OrderId,
					 --  (Case When #tmpOrderProductLotInfos.OrderProductGuid is null then #tmpOrderProductLotInfos.OrderProductId else (select top 1 OrderProductId from OrderProduct where OrderProductGuid = #tmpOrderProductLotInfos.OrderProductGuid) end) as abc
						--,#tmpOrderProductLotInfos.ProductCode,
						--#tmpOrderProductLotInfos.LotNumber,
						--#tmpOrderProductLotInfos.Quantity,
						--#tmpOrderProductLotInfos.CollectedQuantity,
						--#tmpOrderProductLotInfos.DeliveredQuantity,
						--#tmpOrderProductLotInfos.OrderProductLotGuId,
						--1     
						--from #tmpOrderProductLotInfos 	
						--where #tmpOrderProductLotInfos.OrderProductLotGuId is not null 
						--and #tmpOrderProductLotInfos.OrderProductLotGuId not in (select OrderProductLotGuId from OrderProductLotDetails where OrderId = @orderId and OrderProductLotGuId is not null)
						--and #tmpOrderProductLotInfos.[OrderId] = @orderId
						


			 SELECT * INTO #tmpOrderPaymentInfos
			FROM OPENXML(@intpointer,'Json/OrderList/OrderPaymentJson',2)
			 WITH
             (
				[OrderNumber] nvarchar(50) ,
				[UserId] bigint,
				[CollectedAmount] float,
				[TotalAmount] float ,
				[IsActive] bit
			 ) tmp
        	
		Declare @OrderPaymentId bigint
		if exists (Select * from OrderPayment where OrderNumber=@OrderNumber )
			BEGIN
			Set @OrderPaymentId = (Select Top 1 OrderPaymentId from OrderPayment where OrderNumber=@OrderNumber )
			UPDATE [dbo].[OrderPayment]
			   SET 
				   [OrderNumber] = tmpop.[OrderNumber]
			      ,[UserId] = tmpop.[UserId]
			      ,[CollectedAmount] = tmpop.[CollectedAmount]
			      ,[TotalAmount] = tmpop.[TotalAmount]
			      ,[ModifiedBy] =1
			      ,[ModifiedDate] = GETDATE()
			      ,[IsActive] =1
			FROM #tmpOrderPaymentInfos tmpop  
			WHERE [dbo].[OrderPayment].[OrderNumber]=tmpop.[OrderNumber]

			END
		else
			BEGIN
				INSERT INTO [dbo].[OrderPayment]([OrderNumber],[UserId],[CollectedAmount],[TotalAmount],[CreatedBy],[CreatedDate],[IsActive])
				Select [OrderNumber],[UserId],[CollectedAmount],[TotalAmount],1,GETDATE(),1 from #tmpOrderPaymentInfos 
					
				 SET @OrderPaymentId = @@IDENTITY


				 SELECT * INTO #OrderPaymentDetails
				FROM OPENXML(@intpointer,'Json/OrderList/OrderPaymentJson/OrderPaymentDetails',2)
				 WITH
			     (
					[OrderPaymentId] nvarchar(50) ,
					[ItemId] bigint,
					[TotalBuybackAmount] nvarchar(50),
					[TotalBuybackQuantity] nvarchar(50) ,
					[UOM] nvarchar(50),
					[IsActive] bit
				 ) tmp
				 INSERT INTO [dbo].[OrderPaymentDetail]([OrderPaymentId],[ItemId],[TotalBuybackAmount],[TotalBuybackQuantity],[UOM],[CreatedDate],[IsActive])
				 Select @OrderPaymentId,[ItemId],[TotalBuybackAmount],[TotalBuybackQuantity],[UOM],GETDATE(),1 from #OrderPaymentDetails
				 
			END


		




			SELECT * INTO #tmpOrderDocumentInfos
			FROM OPENXML(@intpointer,'Json/OrderList/OrderDocumentInfos',2)
			 WITH
             (
			[OrderId] bigint,
			[OrderProductId] bigint,
			[OrderNumber] nvarchar(50),
			[DocumentTypeId] int,
			[DocumentFormat] nvarchar(50),
			[DocumentBlob] nvarchar(max),
			[CreatedDate] datetime,
			[DocumentDescription] nvarchar(250)
		 ) tmp


		 Declare @DocumentTypeId bigint

		 print  @orderId
		 print  @OrderNumber

		--set @DocumentTypeId=(select top 1 [DocumentTypeId] from #tmpOrderDocumentInfos where #tmpOrderDocumentInfos.[OrderNumber]=@OrderNumber)



	--Update document Record

		 	UPDATE [dbo].[OrderDocument]
			SET  
			@DocumentTypeId=#tmpOrderDocumentInfos.[DocumentTypeId]
			,[DocumentFormat] =#tmpOrderDocumentInfos.[DocumentFormat]
           ,[DocumentBlob]=#tmpOrderDocumentInfos.[DocumentBlob]
		   ,DocumentDescription = #tmpOrderDocumentInfos.[DocumentDescription]
			FROM #tmpOrderDocumentInfos  
			WHERE [dbo].[OrderDocument].[DocumentTypeId]=#tmpOrderDocumentInfos.[DocumentTypeId]
			and [dbo].[OrderDocument].[OrderId]=@orderId
			and [dbo].[OrderDocument].[DocumentBlob]=#tmpOrderDocumentInfos.[DocumentBlob]

			print  @DocumentTypeId

			--if not exists (Select * from [dbo].[OrderDocument] where [OrderId]=@orderId and [DocumentTypeId]=@DocumentTypeId)
			--BEGIN

			print 'Order Document Insert Call'

			INSERT INTO [dbo].[OrderDocument]
           ([OrderId]
           ,[OrderProductId]
           ,[DocumentTypeId]
           ,[DocumentFormat]
           ,[DocumentBlob]
           ,[CreatedDate]
		   ,DocumentDescription)
			select @orderId,[OrderProductId],[DocumentTypeId],[DocumentFormat],[DocumentBlob],getdate()  , DocumentDescription 
			from #tmpOrderDocumentInfos 
			where #tmpOrderDocumentInfos.[OrderNumber]=@OrderNumber and [DocumentBlob] 
			not in (Select DocumentBlob from OrderDocument where OrderId=@orderId)
			--end


			------------------------------------------------------------ Order Dynamic Form Data ----------------------------------------------------------------------------

			
			SELECT * INTO #tmpOrderTemplateFormsDataInfos
			FROM OPENXML(@intpointer,'Json/OrderList/OrderTemplateFormsDataInfos',2)
			 WITH
             (
			[TemplateFormId] bigint,
			[OrderId] bigint,
			[ItemId] bigint,
			[LabelName] nvarchar(250),
			[ControlName]  nvarchar(250),
			[ControlType] nvarchar(150),
			[ControlValue] nvarchar(150),
			[IsActive] nvarchar(max),
			[CreatedDate] datetime
		 ) tmp

		 
			INSERT INTO [dbo].[TemplateFormsData]
           ([TemplateFormId]
           ,[OrderId]
           ,[ItemId]
		  , [LabelName]
		   ,[ControlName]
           ,[ControlType]
           ,[ControlValue]
		   ,[IsActive]
           ,[CreatedDate])
			select #tmpOrderTemplateFormsDataInfos.[TemplateFormId],@orderId,#tmpOrderTemplateFormsDataInfos.[ItemId],#tmpOrderTemplateFormsDataInfos.[LabelName],
			#tmpOrderTemplateFormsDataInfos.[ControlType],#tmpOrderTemplateFormsDataInfos.[ControlType],#tmpOrderTemplateFormsDataInfos.[ControlValue],1,getdate()  
			from #tmpOrderTemplateFormsDataInfos  left join [TemplateFormsData] TFD 
			 on TFD.TemplateFormId = #tmpOrderTemplateFormsDataInfos.TemplateFormId
			 and TFD.Orderid = #tmpOrderTemplateFormsDataInfos.OrderId
			where #tmpOrderTemplateFormsDataInfos.[OrderId]=@orderId   and TFD.TemplateFormDataId is null

			------------------------------------------------------------ End Order Dynamic Form Data ----------------------------------------------------------------------------

-----------------------------Order Checklist---------------------------------------------------------------------------------


			SELECT * INTO #tmpOrderChecklistInfos
			FROM OPENXML(@intpointer,'Json/OrderList/OrderChecklistInfos',2)
			 WITH
             (
			[ChecklistId] bigint,
			[OrderId] bigint,
			[OrderNumber] nvarchar (500),
			[ProductId] bigint,
			[ProductCode] nvarchar (500),
			[CompartmentId] nvarchar (500),
			[OrderMovementId] bigint,
			[ChecklistDescription] nvarchar(max),
			[StatusCode] bigint,
			[ActivityFormMappingId] bigint,
			[GroupName] nvarchar (500),
			[OrderChecklistGuid] nvarchar(max)

		 ) tmp


		 SELECT * INTO #tmpOrderChecklistResponse
			FROM OPENXML(@intpointer,'Json/OrderList/OrderChecklistInfos/OrderChecklistResponse',2)
			 WITH
             (
			[ChecklistId] bigint,
			[ChecklistResponseId] bigint,
			[OrderChecklistId] bigint,
			[ResponseDetails] nvarchar(max) ,
			[ResponseDataType] nvarchar(100) ,
			[Latitude] nvarchar(100),
			[Longitude] nvarchar(100),
			[OrderChecklistGuid] nvarchar(max)
		 ) tmp


		 UPDATE [dbo].[OrderChecklist]
		SET [ChecklistDescription] = tmp.[ChecklistDescription]
		FROM #tmpOrderChecklistInfos tmp  
		WHERE [dbo].[OrderChecklist].[ChecklistId]=tmp.[ChecklistId]
		and [dbo].[OrderChecklist].[OrderNumber]=tmp.[OrderNumber]
		and [dbo].[OrderChecklist].[OrderMovementId]=(Select top 1 OrderMovementId from OrderMovement om where om.OrderId=tmp.[OrderId] and om.GroupName=tmp.GroupName)



		INSERT INTO [dbo].[OrderChecklist](
		[ChecklistId],
		[OrderId],
		[OrderNumber],
		[ProductId],
		[ProductCode],
		[CompartmentId],
		[OrderMovementId],
		[ChecklistDescription],
		[StatusCode],
		[ActivityFormMappingId],
		[OrderChecklistGuid],
		[IsActive],
		[CreatedDate])
		
		Select [ChecklistId],
		[OrderId],
		[OrderNumber],
		[ProductId],
		[ProductCode],
		[CompartmentId],
		(Select top 1 OrderMovementId from OrderMovement om where om.OrderId=tmp.[OrderId] and om.GroupName=tmp.GroupName) as [OrderMovementId],
		[ChecklistDescription],
		[StatusCode],
		[ActivityFormMappingId],
		[OrderChecklistGuid]
		,1,GETDATE() 
		from #tmpOrderChecklistInfos tmp
		 WHERE NOT EXISTS 
		 ( SELECT * FROM [dbo].[OrderChecklist] 
         WHERE [dbo].[OrderChecklist].[ChecklistId]=tmp.[ChecklistId]
		and [dbo].[OrderChecklist].[OrderNumber]=tmp.[OrderNumber]
		and [dbo].[OrderChecklist].[OrderMovementId]=(Select top 1 OrderMovementId from OrderMovement om where om.OrderId=tmp.[OrderId] and om.GroupName=tmp.GroupName));





UPDATE [dbo].[OrderChecklistResponse]
   SET 
       [ResponseDetails] = tmp.[ResponseDetails]
      ,[ResponseDataType] = tmp.[ResponseDataType]
      ,[Latitude] = tmp.[Latitude]
      ,[Longitude] = tmp.[Longitude]
      ,[OrderChecklistGuid] = tmp.[OrderChecklistGuid]

FROM #tmpOrderChecklistResponse tmp 
where [dbo].[OrderChecklistResponse].[ChecklistResponseId]=tmp.[ChecklistResponseId]
and [dbo].[OrderChecklistResponse].[OrderChecklistId]=(SELECT top 1 ocl.[OrderChecklistId] FROM [dbo].[OrderChecklist] ocl where ocl.OrderChecklistGuid=tmp.OrderChecklistGuid)


		INSERT INTO [dbo].[OrderChecklistResponse]
           ([ChecklistResponseId]
           ,[OrderChecklistId]
           ,[ResponseDetails]
           ,[ResponseDataType]
           ,[Latitude]
           ,[Longitude]
           ,[OrderChecklistGuid]
           ,[IsActive]
           ,[CreatedDate])

		SELECT [ChecklistResponseId]
		,(SELECT top 1 ocl.[OrderChecklistId] FROM [dbo].[OrderChecklist] ocl where ocl.OrderChecklistGuid=tmp.OrderChecklistGuid) as [OrderChecklistId]
		,[ResponseDetails]
		,[ResponseDataType]
		,[Latitude]
		,[Longitude]
		,[OrderChecklistGuid]
		,1
		,GETDATE() from #tmpOrderChecklistResponse tmp
		 WHERE NOT EXISTS 
		 ( SELECT * FROM [dbo].[OrderChecklistResponse] oclr 
		 where oclr.[ChecklistResponseId]=tmp.[ChecklistResponseId]
         and oclr.[OrderChecklistId]=(SELECT top 1 ocl.[OrderChecklistId] FROM [dbo].[OrderChecklist] ocl where ocl.OrderChecklistGuid=tmp.OrderChecklistGuid)
		 )



		 ------------------------------------------------------------ Order feedback infos ----------------------------------------------------------------------------

			
			SELECT * INTO #tmpOrderFeedbackList
			FROM OPENXML(@intpointer,'Json/OrderList/OrderFeedbackInfos',2)
			 WITH
             (
			[OrderId] bigint,
			[Remarks] nvarchar(500),
			[Attachment]  nvarchar(max),
			FeedbackType nvarchar(500)
			
		 ) tmp



		
		 ------insert  order feedback  ------
		 
		INSERT INTO [dbo].[OrderFeedback]
           ([OrderId]
            ,[Attachment]
			,[FeedbackType]
			,[IsActive]
           ,[Comment]
           ,[CreatedBy]
           ,[CreatedDate]
          )
    select #tmpOrderFeedbackList.OrderId ,
	#tmpOrderFeedbackList.Attachment ,
		#tmpOrderFeedbackList.FeedbackType ,
		1,
 #tmpOrderFeedbackList.Remarks ,
   '1',
   GETDATE()
	From    #tmpOrderFeedbackList   left join  OrderFeedback  ofb on  
	  #tmpOrderFeedbackList.OrderId = ofb.OrderId    and    #tmpOrderFeedbackList.FeedbackType = ofb.FeedbackType
	  where ofb.OrderId  is  null  

	

			------------------------------------------------------------ End Order Dynamic Form Data ----------------------------------------------------------------------------





		 UPDATE dbo.[Order] SET
			@orderId=tmp.IntOrderId
            FROM OPENXML(@intpointer,'Json/OrderList',2)
			 WITH
             (
			IntOrderId bigint)tmp

			exec [dbo].[ISP_InsertInEventNotification] @currentState,@orderId


           SELECT @orderId as OrderId FOR XML RAW('Json'),ELEMENTS
           exec sp_xml_removedocument @intPointer
		END TRY
		BEGIN CATCH
		SELECT @ErrMsg = ERROR_MESSAGE();
		RAISERROR(@ErrMsg, @ErrSeverity, 1);
		RETURN; 
		END CATCH
END

PRINT 'Successfully created procedure dbo.USP_Enquiry'