CREATE PROCEDURE [dbo].[SSP_GateKeeperTruckInConfirmation] --'<Json><OrderId>76566</OrderId><OrderType>SO</OrderType><rownumber>1</rownumber><TotalCount>1</TotalCount><OrderNumber>18016789</OrderNumber><HoldStatus>-</HoldStatus><TotalPrice>30579983.10</TotalPrice><SalesOrderNumber>18016789</SalesOrderNumber><SOGratisNumber>18016789</SOGratisNumber><PurchaseOrderNumber>-</PurchaseOrderNumber><ProposedShift /><ProposedTimeOfAction /><StatusForChangeInPickShift>1</StatusForChangeInPickShift><OrderDate>2018-04-12T11:10:12.363Z</OrderDate><DeliveryLocationName>CP(D)-DOANH NGHIEP TN VIET HONG</DeliveryLocationName><DeliveryLocation>1110352</DeliveryLocation><CompanyName>CP(D)</CompanyName><CompanyMnemonic>1110352</CompanyMnemonic><UserName>OM</UserName><ExpectedTimeOfDelivery>12/04/2018</ExpectedTimeOfDelivery><RequestDate>12/04/2018</RequestDate><ReceivedCapacityPalettes>-70</ReceivedCapacityPalettes><Capacity>112</Capacity><IsRPMPresent>0</IsRPMPresent><EnquiryAutoNumber>INQ002016</EnquiryAutoNumber><ProductCode>65201011</ProductCode><ProductName>Heineken 330x24B Ctn Alu</ProductName><ProductQuantity>900</ProductQuantity><OrderedBy>OM</OrderedBy><CarrierNumberValue>21000137</CarrierNumberValue><Field1 /><CurrentState>1103</CurrentState><Status>Plate Number Allocated</Status><Class>PlateNumberUpdated_Status</Class><OrderProductList><OrderProductId>78450</OrderProductId><OrderId>76566</OrderId><ProductCode>65201011</ProductCode><ProductType>9</ProductType><ItemType>32</ItemType><ItemName>Heineken 330x24B Ctn Alu</ItemName><ProductQuantity>900</ProductQuantity><ItemPricesPerUnit>0</ItemPricesPerUnit><ItemPrices>0</ItemPrices><DepositeAmountPerUnit>0</DepositeAmountPerUnit><ItemTotalDepositeAmount>0</ItemTotalDepositeAmount><UOM>Carton</UOM><ItemTax>10</ItemTax><AssociatedOrder>0</AssociatedOrder><UsedQuantityInOrder>900.00</UsedQuantityInOrder><ProductAvailableQuantity>0</ProductAvailableQuantity><IsItemAvailableInStock>false</IsItemAvailableInStock></OrderProductList><OrderProductList><OrderProductId>78453</OrderProductId><OrderId>76566</OrderId><ProductCode>65206012</ProductCode><ProductType>9</ProductType><ItemType>32</ItemType><ItemName>Heineken Keg 20L David</ItemName><ProductQuantity>19</ProductQuantity><ItemPricesPerUnit>740909</ItemPricesPerUnit><ItemPrices>14077271</ItemPrices><DepositeAmountPerUnit>5000</DepositeAmountPerUnit><ItemTotalDepositeAmount>95000</ItemTotalDepositeAmount><UOM>Keg</UOM><ItemTax>10</ItemTax><AssociatedOrder>0</AssociatedOrder><UsedQuantityInOrder>19.00</UsedQuantityInOrder><ProductAvailableQuantity>41</ProductAvailableQuantity><IsItemAvailableInStock>true</IsItemAvailableInStock></OrderProductList><OrderProductList><OrderProductId>78452</OrderProductId><OrderId>76566</OrderId><ProductCode>65105011</ProductCode><ProductType>9</ProductType><ItemType>32</ItemType><ItemName>Tiger 330x24C Ctn</ItemName><ProductQuantity>50</ProductQuantity><ItemPricesPerUnit>272727</ItemPricesPerUnit><ItemPrices>13636350</ItemPrices><DepositeAmountPerUnit>0</DepositeAmountPerUnit><ItemTotalDepositeAmount>0</ItemTotalDepositeAmount><UOM>Carton</UOM><ItemTax>10</ItemTax><AssociatedOrder>0</AssociatedOrder><UsedQuantityInOrder>50.00</UsedQuantityInOrder><ProductAvailableQuantity>87782</ProductAvailableQuantity><IsItemAvailableInStock>true</IsItemAvailableInStock></OrderProductList><OrderProductList><OrderProductId>78451</OrderProductId><OrderId>76566</OrderId><ProductCode>55909001</ProductCode><ProductType>9</ProductType><ItemType>0</ItemType><ItemName>Wooden Pallet</ItemName><ProductQuantity>14</ProductQuantity><ItemPricesPerUnit>0</ItemPricesPerUnit><ItemPrices>0</ItemPrices><DepositeAmountPerUnit>0</DepositeAmountPerUnit><ItemTotalDepositeAmount>0</ItemTotalDepositeAmount><UOM>Each</UOM><ItemTax>10</ItemTax><AssociatedOrder>0</AssociatedOrder><UsedQuantityInOrder>14.00</UsedQuantityInOrder><ProductAvailableQuantity>0</ProductAvailableQuantity></OrderProductList><OrderProductList><OrderProductId>78454</OrderProductId><OrderId>76566</OrderId><ProductCode>65999001</ProductCode><ProductType>9</ProductType><ItemType>39</ItemType><ItemName>TIEN THE CHAP (CD Refundable)</ItemName><ProductQuantity>19</ProductQuantity><ItemPricesPerUnit>5000</ItemPricesPerUnit><ItemPrices>95000</ItemPrices><DepositeAmountPerUnit>0</DepositeAmountPerUnit><ItemTotalDepositeAmount>0</ItemTotalDepositeAmount><UOM>Carton</UOM><ItemTax>10</ItemTax><AssociatedOrder>0</AssociatedOrder><UsedQuantityInOrder>19.00</UsedQuantityInOrder><ProductAvailableQuantity>1.20355e+007</ProductAvailableQuantity><IsItemAvailableInStock>true</IsItemAvailableInStock></OrderProductList><ShipTo>596</ShipTo><SoldTo>554</SoldTo><ReceivedCapacityPalettesCheck>0</ReceivedCapacityPalettesCheck><Note /><StockLocationId>636</StockLocationId><BranchPlantName>6426</BranchPlantName><DeliveryLocationBranchName>VBB - CN tai Can Tho</DeliveryLocationBranchName><Empties>W</Empties><EmptiesLimit>57000</EmptiesLimit><ActualEmpties>987</ActualEmpties><PreviousState>1103</PreviousState><TruckSizeId>21</TruckSizeId><TruckSize>H16</TruckSize><PlateNumberData>12345</PlateNumberData><PlateNumber>1234567</PlateNumber><PreviousPlateNumber>12345</PreviousPlateNumber><DriverName>Do Quoc Nhat</DriverName><ProfileId>397</ProfileId><TruckInPlateNumber>12345</TruckInPlateNumber><TruckOutPlateNumber>12345</TruckOutPlateNumber><TruckInDateTime /><TruckOutDateTime /><CarrierNumber>1220</CarrierNumber><ExpectedShift>1107</ExpectedShift><ExpectedTimeOfAction>26/07/2018</ExpectedTimeOfAction><DeliveryPersonnelId>383</DeliveryPersonnelId><IsEditOrderStatusConfiguration>false</IsEditOrderStatusConfiguration><OrderGUID>222f0197-7b77-492a-ae87-c3861460565e</OrderGUID><IsTruckInDisabled>false</IsTruckInDisabled><IsTruckOutDisabled>false</IsTruckOutDisabled><IsAvailableStock>false</IsAvailableStock><IsGratisItemAvailable>false</IsGratisItemAvailable><LocationType>1</LocationType><UserId>7</UserId><TruckOutPlateNumberCheck>false</TruckOutPlateNumberCheck><TruckInPlateNumberCheck>true</TruckInPlateNumberCheck><PlateNumberBy>TruckIn</PlateNumberBy></Json>'
@xmlDoc xml 
AS 
 BEGIN 
	SET ARITHABORT ON 
	DECLARE @TranName NVARCHAR(255) 
	DECLARE @ErrMsg NVARCHAR(2048) 
	DECLARE @ErrSeverity INT; 
	DECLARE @intPointer INT; 
	SET @ErrSeverity = 15; 

		BEGIN TRY



		DECLARE @SalesOrderNumber nvarchar(150)
		DECLARE @pickingDate nvarchar(150)
		DECLARE @plateNumber nvarchar(150)
		DECLARE @revisedplateNumber nvarchar(150)
		DECLARE @userId bigint
		DECLARE @remark nvarchar(500)
		DECLARE @locationType nvarchar(150)
		Declare @PlateNumberBy nvarchar(100)
		declare @DeliveryPersonnelId nvarchar(150)
		DECLARE @field1 nvarchar(50)
			EXEC sp_xml_preparedocument @intpointer OUTPUT,@xmlDoc
	
		SELECT @SalesOrderNumber = tmp.[SalesOrderNumber],
				@pickingDate=tmp.[PickingDate],
				@plateNumber=tmp.[PlateNumber],
				@revisedplateNumber=tmp.[RevisedPlateNumber],
				@locationType=tmp.[LocationType],
				@userId=tmp.UserId,
				@remark=tmp.Remarks,
				@PlateNumberBy = tmp.[PlateNumberBy],
				@DeliveryPersonnelId = tmp.[DeliveryPersonnelId],
				@field1=tmp.[Field1]
	  

FROM OPENXML(@intpointer,'Json',2)
			WITH
			(
			[SalesOrderNumber] NVARCHAR(50),
			[PickingDate] nvarchar(50),
			[PlateNumber] nvarchar(50),
			[RevisedPlateNumber] nvarchar(50),
			[LocationType] nvarchar(50),
			UserId bigint,
			Remarks nvarchar(500),
			[PlateNumberBy] nvarchar(100),
			[DeliveryPersonnelId] nvarchar(50),
			[Field1] nvarchar(100)
			)tmp 


			SELECT TOP 1 OrderId,OrderNumber,TruckSizeId,ROW_NUMBER() OVER (ORDER BY OrderId) AS rownum INTO #tmpTable FROM dbo.[Order] WHERE SalesOrderNumber=@SalesOrderNumber			
			
	
			DECLARE @orderId bigint	
			DECLARE @orderLogisticId bigint
			SET @orderId=(SELECT OrderId FROM #tmpTable)
					
			Declare @OrderMovementId bigint

			SET @OrderMovementId = (SELECT OrderMovementId FROM OrderMovement WHERE OrderId=@orderId AND LocationType=@locationType)

		SET @orderLogisticId = (SELECT OrderLogisticsId FROM [OrderLogistics] WHERE OrderMovementId = @OrderMovementId)

			Declare @IsPresentOrNot bigint
			SET @IsPresentOrNot=(Select Count(OrderLogisticsId) from [OrderLogistics] where OrderLogisticsId=@orderLogisticId)
			if @IsPresentOrNot = 0
			BEGIN
			Print '1'
			
					--INSERT INTO [dbo].[orderMovement]  ([OrderId],LocationType,DeliveryPersonnelId,ExpectedTimeOfAction,ActualTimeOfAction,[IsActive],[CreatedBy],[CreatedDate])
					--SELECT  	#tmpTable.OrderId,@locationType, @DeliveryPersonnelId,  convert(datetime,@pickingDate, 103)  ,convert(datetime,@pickingDate, 103),1,1,getdate()
					--FROM #tmpTable
				
					--SELECT  @orderMovementId  = @@IDENTITY 


					--INSERT INTO [dbo].[OrderLogistics]  ([OrderMovementId],[TruckPlateNumber],[DeliveryPersonnelId],[TruckInTime],[IsActive],[CreatedBy],[CreatedDate])
					--SELECT  	@orderMovementId,@plateNumber,@DeliveryPersonnelId,GETDATE(),1,1,getdate()
						
					--SELECT  @orderLogisticId  = @@IDENTITY 
				
		

				--	SELECT OrderProductId,ProductQuantity,ROW_NUMBER() OVER (ORDER BY OrderProductId) AS rownum INTO #tmpOrderProduct FROM dbo.[OrderProduct] WHERE OrderId=@orderId	
				--	DECLARE @orderProductId BIGINT
				--	DECLARE @quantity DECIMAL(18,2)
				--	DECLARE @totalRecords BIGINT
				--	DECLARE @RecordCount BIGINT
				--	SELECT @RecordCount = 1
				--	SELECT @totalRecords = COUNT(OrderProductId) FROM #tmpOrderProduct
				--	WHILE (@RecordCount <= @totalRecords)
				--BEGIN
				--SELECT @orderProductId=OrderProductId,@quantity=ProductQuantity FROM #tmpOrderProduct WHERE rownum=@RecordCount

				--	INSERT INTO [dbo].OrderProductMovement  (OrderId,OrderProductId,OrderMovementId,PlannedQuantity,ActualQuantity,[IsActive],[CreatedBy],[CreatedDate])
				--	Select	@orderId ,@orderProductId,@orderMovementId,@quantity,@quantity,1,1,GETDATE()
				--		FROM #tmpOrderProduct WHERE rownum=@totalRecords
				--		set @RecordCount=@RecordCount+1
				--END


				 if @field1='SCO'
				 BEGIN
				 INSERT INTO [dbo].[OrderLogistics]  ([OrderMovementId],[DeliveryPersonName],[TruckInTime],[TruckPlateNumber],[IsActive],[CreatedBy],[CreatedDate])
							SELECT  @OrderMovementId,@DeliveryPersonnelId,GETDATE(),@plateNumber,1,@UserId,getdate()
						
							SELECT  @orderLogisticId  = @@IDENTITY 

							INSERT INTO [dbo].[OrderLogisticHistory]  ([OrderId],[UserId],[OrderLogisticId],[TruckId],[PlateNumber],
							[TransportVehicleId],[DeliveryPersonName],[OrderMovementId],PlateNumberBy,[IsActive],[CreatedBy],[CreatedDate])
							SELECT  @orderId,@UserId,@orderLogisticId,NULL,@plateNumber,NULL,@DeliveryPersonnelId,@OrderMovementId,@PlateNumberBy,1,@UserId,getdate()
							update OrderMovement set DeliveryPersonnelId=@DeliveryPersonnelId where OrderMovementId=@OrderMovementId


							
				 END
				 ELSe
				 BEGIN
				 INSERT INTO [dbo].[OrderLogistics]  ([OrderMovementId],[DeliveryPersonnelId],[TruckPlateNumber],[IsActive],[CreatedBy],[CreatedDate])
							SELECT  @OrderMovementId,@DeliveryPersonnelId,@plateNumber,1,@UserId,getdate()
						
							SELECT  @orderLogisticId  = @@IDENTITY 


							INSERT INTO [dbo].[OrderLogisticHistory]  ([OrderId],[UserId],[OrderLogisticId],[TruckId],[PlateNumber],
							[TransportVehicleId],[DeliveryPersonnelId],[OrderMovementId],PlateNumberBy,[IsActive],[CreatedBy],[CreatedDate])
							SELECT  @orderId,@UserId,@orderLogisticId,NULL,@plateNumber,NULL,@DeliveryPersonnelId,@OrderMovementId,@PlateNumberBy,1,@UserId,getdate()
							update OrderMovement set DeliveryPersonnelId=@DeliveryPersonnelId where OrderMovementId=@OrderMovementId
				 END
					

		END
		BEGIN
	Print '2'
		SET @orderLogisticId=(SELECT OrderLogisticsId FROM [OrderLogistics] WHERE ordermovementid=(SELECT ordermovementid FROM OrderMovement WHERE OrderId=@orderId AND LocationType=@locationType))
		 if @field1='SCO'
		 BEGIN
			UPDATE [OrderLogistics] SET [TruckPlateNumber]=@plateNumber,[TruckInTime]=GETDATE(),[DeliveryPersonName]=@DeliveryPersonnelId WHERE ordermovementid = (SELECT ordermovementid FROM OrderMovement WHERE OrderId=@orderId AND LocationType=@locationType)
			INSERT INTO [dbo].[OrderLogisticHistory]  ([OrderId],[UserId],[OrderLogisticId],[TruckId],[PlateNumber],
			[TransportVehicleId],[DeliveryPersonName],[OrderMovementId],PlateNumberBy,[Remark],[IsActive],[CreatedBy],[CreatedDate])
						SELECT  	@orderId,@userId,@orderLogisticId,NULL,@plateNumber,NULL,@DeliveryPersonnelId,@orderMovementId,@PlateNumberBy,@remark,1,1,getdate()
		 END
		 ELSE
		 BEGIN
			UPDATE [OrderLogistics] SET [TruckPlateNumber]=@plateNumber,[TruckInTime]=GETDATE(),DeliveryPersonnelId=@DeliveryPersonnelId WHERE ordermovementid = (SELECT ordermovementid FROM OrderMovement WHERE OrderId=@orderId AND LocationType=@locationType)
			INSERT INTO [dbo].[OrderLogisticHistory]  ([OrderId],[UserId],[OrderLogisticId],[TruckId],[PlateNumber],
			[TransportVehicleId],[DeliveryPersonnelId],[OrderMovementId],PlateNumberBy,[Remark],[IsActive],[CreatedBy],[CreatedDate])
						SELECT  	@orderId,@userId,@orderLogisticId,NULL,@plateNumber,NULL,@DeliveryPersonnelId,@orderMovementId,@PlateNumberBy,@remark,1,1,getdate()
		 END
		END
			

			update [Order] set CurrentState=1104 where OrderId=@orderId
    
   
    exec sp_xml_removedocument @intPointer 	
    END TRY
    BEGIN CATCH
    SELECT @ErrMsg = ERROR_MESSAGE(); 
    RAISERROR(@ErrMsg, @ErrSeverity, 1); 
    RETURN; 
    END CATCH
END
