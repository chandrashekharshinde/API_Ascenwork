
CREATE PROCEDURE [dbo].[ISP_AddOwnProduct] --'<Json><ServicesAction>AddOwnProduct</ServicesAction><ItemList><ItemName>test 5</ItemName><ItemCode>9888877012</ItemCode><Price></Price><PrimaryUOM>304</PrimaryUOM><ProductPhoto>iVBORw0KGgoAAAANSUhEUgAAACwAAAAzCAYAAADsBOpPAAAACXBIWXMAAAsSAAALEgHS3X78AAADXElEQVRogc1ZsVLbQBB9p1CQzplr0iEKadLFdOmALumcLh34C+x8QcIXkHwBpkxld5lUOB2pcDpGKoCSwh5KUimzsDK20J3u5DvQ62Td3j2v3u3t7sEHRBzteJkYwJrLyUQctQAcAejQo8u5czgjLOKoDWAIIHQ1ZxkCF5OIOPoK4Mw3WazqYZYAedWbZouo7WHeWBdPSRZ1CYs4OgRwAqDlnlLF2laD4yhkCbQtzCYAbgD8BjDOknRsT3OBg/HAOOpwyFrVq0R+BOC4DnkjwiyBfi16ehDhAxvipoTPLGVgC/J4N0vSmyo70023C2DgkTDJ7cLkSLfddK50rAN5WumcF1ZTTWfnQsofHHtfV4ymr/IXwDmAW4tTsCOkvMJ0Nil7WTtBqdqIWZIuzc2nIn2hL4bkSz29UkbFmhuWSaRIuGC3D+DQQFpbWZIueXql5IfD0SaHJxu7gaHdkL/MHCtnaxSKsiQlvR7UtNNFn5AlNIfTJJslQlEk1EmixI5s9jVDNrMkvYSrfDgHS2Srhre7nHOoMPeylzKmDjixOtNsxDsv28Vhn5jOboSULzX5NcXmU6eScIBvnM2VYQ9NkkSOigPpVdM8TDjWvNtpHGE+2VSyaDfRw9CEuI2mEr5U/B42lfCV6sVaSTOE/t3HYpbUFASc5i0G67yUf05sqNYOFElH6LNlagBVgn+p07DPKrkKqrWvAk0I2X4Opty2VSVAk0CT9XeK2f4TYU+zzDjgnpcKPro9SrCDVIn8hKqUIEvSkeYo7D2xl/saOdzlGPmmGykGtYo1lS9wAt/TTD9aJKwrafrc8fGN0nYBY7BU0/GDrno94t3rBVyE6uafO3QxDn/WaJn++YkP0gYV80HuXSz11qazWyHlPwDvFYbrAD4JKa9VfS9Loi0h5U9uX6lARLvE7THhe9KnQspQ83nWuVnXFlL+ocKxJlnyKJF9oxlGc39Y9C7KajoOYyeGRzPp/rtJZue1GWhJGvzpxpzHLpY4+TG7bXk9puwR6zqMtqRdQdvQrizzPV7IFEFfZbdKXtWdn+nsl5CSOunvPF4VDMo2WBlsOowt9nTPIXE/115LBg+7vVdT3/nFolF0ebR+jQUfjO8TFtr9b5k8PRdDFnmPSJKsVru6BfAf7HUYzWbt9ZoAAAAASUVORK5CYII=</ProductPhoto><ItemOwner>10001</ItemOwner><ImageUrl>/Images/ProductImages/988887707.jpg</ImageUrl><CreatedBy>10621</CreatedBy></ItemList><ItemList><ItemName>test 6</ItemName><ItemCode>988887709</ItemCode><Price></Price><PrimaryUOM>304</PrimaryUOM><ProductPhoto>iVBORw0KGgoAAAANSUhEUgAAACwAAAAzCAYAAADsBOpPAAAACXBIWXMAAAsSAAALEgHS3X78AAADXElEQVRogc1ZsVLbQBB9p1CQzplr0iEKadLFdOmALumcLh34C+x8QcIXkHwBpkxld5lUOB2pcDpGKoCSwh5KUimzsDK20J3u5DvQ62Td3j2v3u3t7sEHRBzteJkYwJrLyUQctQAcAejQo8u5czgjLOKoDWAIIHQ1ZxkCF5OIOPoK4Mw3WazqYZYAedWbZouo7WHeWBdPSRZ1CYs4OgRwAqDlnlLF2laD4yhkCbQtzCYAbgD8BjDOknRsT3OBg/HAOOpwyFrVq0R+BOC4DnkjwiyBfi16ehDhAxvipoTPLGVgC/J4N0vSmyo70023C2DgkTDJ7cLkSLfddK50rAN5WumcF1ZTTWfnQsofHHtfV4ymr/IXwDmAW4tTsCOkvMJ0Nil7WTtBqdqIWZIuzc2nIn2hL4bkSz29UkbFmhuWSaRIuGC3D+DQQFpbWZIueXql5IfD0SaHJxu7gaHdkL/MHCtnaxSKsiQlvR7UtNNFn5AlNIfTJJslQlEk1EmixI5s9jVDNrMkvYSrfDgHS2Srhre7nHOoMPeylzKmDjixOtNsxDsv28Vhn5jOboSULzX5NcXmU6eScIBvnM2VYQ9NkkSOigPpVdM8TDjWvNtpHGE+2VSyaDfRw9CEuI2mEr5U/B42lfCV6sVaSTOE/t3HYpbUFASc5i0G67yUf05sqNYOFElH6LNlagBVgn+p07DPKrkKqrWvAk0I2X4Opty2VSVAk0CT9XeK2f4TYU+zzDjgnpcKPro9SrCDVIn8hKqUIEvSkeYo7D2xl/saOdzlGPmmGykGtYo1lS9wAt/TTD9aJKwrafrc8fGN0nYBY7BU0/GDrno94t3rBVyE6uafO3QxDn/WaJn++YkP0gYV80HuXSz11qazWyHlPwDvFYbrAD4JKa9VfS9Loi0h5U9uX6lARLvE7THhe9KnQspQ83nWuVnXFlL+ocKxJlnyKJF9oxlGc39Y9C7KajoOYyeGRzPp/rtJZue1GWhJGvzpxpzHLpY4+TG7bXk9puwR6zqMtqRdQdvQrizzPV7IFEFfZbdKXtWdn+nsl5CSOunvPF4VDMo2WBlsOowt9nTPIXE/115LBg+7vVdT3/nFolF0ebR+jQUfjO8TFtr9b5k8PRdDFnmPSJKsVru6BfAf7HUYzWbt9ZoAAAAASUVORK5CYII=</ProductPhoto><ItemOwner>10001</ItemOwner><ImageUrl></ImageUrl><CreatedBy>10621</CreatedBy></ItemList></Json>'
@xmlDoc xml 
AS 
 BEGIN 
	SET ARITHABORT ON 
	DECLARE @TranName NVARCHAR(255) 
	DECLARE @ErrMsg NVARCHAR(2048) 
	DECLARE @ErrSeverity INT; 
	DECLARE @intPointer INT;
	SET @ErrSeverity = 15; 

		BEGIN TRY
			EXEC sp_xml_preparedocument @intpointer OUTPUT,@xmlDoc

			DECLARE @UserId bigint;
        SELECT * INTO #TmpProductList
		FROM OPENXML(@intpointer,'Json/ItemList',2)
			WITH
        (
		[ItemName] nvarchar(50),
		[ItemCode] nvarchar(50),
		[ItemShortCode] nvarchar(50),
		[PrimaryUOM] nvarchar(50),
		[ImageUrl] nvarchar(500),
		[ProductPhoto] nvarchar(max),
		[CreatedBy] BIGINT,
		[ItemOwner] BIGINT,
		[CompanyId] BIGINT,
		[CompanyMnemonic] nvarchar(max)
		)tmp

			
			UPDATE dbo.item
			SET 
			dbo.item.[ImageUrl]=#TmpProductList.[ImageUrl],
			--dbo.item.Field10=#TmpProductList.[ProductPhoto],
			dbo.item.[ItemName]=#TmpProductList.[ItemName],
			dbo.item.[ItemShortCode]=#TmpProductList.[ItemShortCode],
			dbo.item.[PrimaryUnitOfMeasure]=#TmpProductList.[PrimaryUOM],
			dbo.item.ModifiedDate=getdate()
			FROM #TmpProductList 
			WHERE dbo.item.[ItemCode]=#TmpProductList.[ItemCode]
			and dbo.item.[ItemOwner]=#TmpProductList.[ItemOwner]
			and dbo.item.[IsActive] = 1
			


        INSERT INTO	[Item]
        (
        	[ItemName],
        	[ItemCode],
			[ItemShortCode],
        	[PrimaryUnitOfMeasure],
        	[StockInQuantity],
        	[ImageUrl],
			--Field10,
			[ProductType],
        	[CreatedBy],
        	[CreatedDate],        	
        	[IsActive],
			[ItemOwner]
        
        )

        SELECT
        	tproductlist.[ItemName],
        	tproductlist.[ItemCode],
			tproductlist.[ItemShortCode],
        	tproductlist.[PrimaryUOM],
        	0,
        	CASE WHEN tproductlist.[ImageUrl] = '' THEN NULL ELSE tproductlist.[ImageUrl] END,
			--tproductlist.[ProductPhoto],
			9,
        	tproductlist.[CreatedBy],
        	GETDATE(),        	
        	1,
			tproductlist.[ItemOwner]
        	
            FROM #TmpProductList tproductlist

			where 
			NOT EXISTS 
		 (
		 select itm.[ItemCode] from item itm where itm.isactive = 1 and itm.[ItemCode] = tproductlist.[ItemCode]
		 )

			
        
        DECLARE @Item bigint
		set @Item=0;
	    SET @Item = @@IDENTITY

		   INSERT INTO [dbo].[ItemSupplier]
           ([ItemId]
           ,[ItemCode]
           ,[ItemShortCode]
           ,[CompanyId]
           ,[CompanyMnemonic]
           ,[IsActive]
           ,[CreatedBy]
           ,[CreatedDate]
		   )

      SELECT
        	 0,
        	tproductlist.[ItemCode],
			tproductlist.[ItemShortCode],
        	tproductlist.[CompanyId],
        	tproductlist.[CompanyMnemonic],
        	1,
        	tproductlist.[CreatedBy],
        	GETDATE()       	
            FROM #TmpProductList tproductlist
			where 
			NOT EXISTS 
		 (
		 select itmsup.[ItemCode] from ItemSupplier itmsup where itmsup.isactive = 1 and itmsup.[ItemCode] = tproductlist.[ItemCode]
		   and itmsup.[CompanyMnemonic] = tproductlist.[CompanyMnemonic] and itmsup.[CompanyId] = tproductlist.[CompanyId]
		 )
	
	  update [dbo].[ItemSupplier]  set [ItemId]= Item.[ItemId] from  [ItemSupplier] itemSup  join Item on Item.ItemCode=itemSup.ItemCode and itemSup.ItemId=0 and itemSup.IsActive=1


		--select * into #ItemList
		--FROM OPENXML(@intpointer,'Json/ItemList',2)
		--WITH
		--(
		--	[ItemName] nvarchar(500),
		--	[ItemCode] nvarchar(200),
		--	[PrimaryUOM] nvarchar(20),
		--	[OpeningBalanceQuantity] decimal(10, 2),
		--	[ImageUrl] nvarchar(max),
		--	[CreatedBy] bigint,
		--	[ItemOwner] bigint,
		--	[Price] nvarchar(500)
		--)tmp1

		--INSERT INTO [dbo].[ItemBasePrice]
  --         ([ItemShortCode]
  --         ,[ItemLongCode]
  --         ,[AddressNumber]
  --         ,[CurrencyCode]
  --         ,[PrimaryUOM]
  --         ,[EffectiveDate]
  --         ,[ExpiryDate]
  --         ,[Price]
  --         ,[CustomerGroupID]
  --         ,[ItemGroupId])
  --   VALUES
  --         (0
  --         ,(select top 1 #ItemList.[ItemCode] from #ItemList)
  --         ,0
  --         ,'VND'
  --         ,'CR'
  --         ,[dbo].[DMYTOJUL] (getdate())
  --         ,[dbo].[DMYTOJUL] (DATEADD(year, 20, getdate()))
  --         ,(select top 1 #ItemList.[Price] from #ItemList)
  --         ,0
  --         ,0)

		--   drop table #ItemList

        
     --Add child table insert procedure when required.
     SELECT @Item as ItemId FOR XML RAW('Json'),ELEMENTS
	
   
    
    exec sp_xml_removedocument @intPointer 	
    END TRY
    BEGIN CATCH
    SELECT @ErrMsg = ERROR_MESSAGE(); 
    RAISERROR(@ErrMsg, @ErrSeverity, 1); 
    RETURN; 
    END CATCH
END
