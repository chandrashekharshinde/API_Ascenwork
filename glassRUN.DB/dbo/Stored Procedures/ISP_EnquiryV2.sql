CREATE PROCEDURE [dbo].[ISP_EnquiryV2] --'<Enquiry xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema"><CopyEnquiryGuid /><EnquiryGuid>30c24a1a-d9e9-4565-9e9f-930441de4331</EnquiryGuid><IsOrderSelfCollect>0</IsOrderSelfCollect><ActivityStartTime>2020/03/25 13:17:01</ActivityStartTime><ProductList><EnquiryGuid>30c24a1a-d9e9-4565-9e9f-930441de4331</EnquiryGuid><EnquiryProductId>0</EnquiryProductId><ItemId>75</ItemId><TotalEnquiriesCount>0</TotalEnquiriesCount><ParentItemId>0</ParentItemId><ProductCode>65201011</ProductCode><PrimaryUnitOfMeasure>Carton</PrimaryUnitOfMeasure><ProductName>Heineken 330x24B Ctn Alu</ProductName><ParentProductCode /><ProductType>9</ProductType><ProductQuantity>300</ProductQuantity><WeightPerUnit>9.48</WeightPerUnit><AssociatedOrder>0</AssociatedOrder><ItemPricesPerUnit>745455</ItemPricesPerUnit><ItemType>32</ItemType><CurrentItemPalettesCorrectWeight>4.166666666666667</CurrentItemPalettesCorrectWeight><CurrentItemTruckCapacityFullInTon>2.844</CurrentItemTruckCapacityFullInTon><IsActive>1</IsActive><PriorityRating>0</PriorityRating><TotalVolume>4.166666666666667</TotalVolume><TotalWeight>2.844</TotalWeight><CollectionLocationCode /><PackingItemCount>4.166666666666667</PackingItemCount><PackingItemCode>0</PackingItemCode><IsPackingItem>0</IsPackingItem><NumberOfExtraPalettes>0</NumberOfExtraPalettes><DepositeAmountPerUnit>0.0</DepositeAmountPerUnit><AllocationExists>0</AllocationExists><AllocationQty>0</AllocationQty><CreatedBy>574</CreatedBy></ProductList><ProductList><EnquiryGuid>30c24a1a-d9e9-4565-9e9f-930441de4331</EnquiryGuid><EnquiryProductId>0</EnquiryProductId><ItemId>16</ItemId><TotalEnquiriesCount>0</TotalEnquiriesCount><ParentItemId>0</ParentItemId><ProductCode>55909001</ProductCode><PrimaryUnitOfMeasure>Each</PrimaryUnitOfMeasure><ProductName>Pallet - Wooden MT</ProductName><ParentProductCode /><ProductType>9</ProductType><ProductQuantity>12</ProductQuantity><WeightPerUnit>0.0</WeightPerUnit><AssociatedOrder>0</AssociatedOrder><ItemPricesPerUnit>0</ItemPricesPerUnit><ItemType>0</ItemType><CurrentItemPalettesCorrectWeight>0</CurrentItemPalettesCorrectWeight><CurrentItemTruckCapacityFullInTon>0.444</CurrentItemTruckCapacityFullInTon><IsActive>1</IsActive><PriorityRating>0</PriorityRating><TotalVolume>0</TotalVolume><TotalWeight>0.444</TotalWeight><CollectionLocationCode /><PackingItemCount>0</PackingItemCount><PackingItemCode>0</PackingItemCode><IsPackingItem>1</IsPackingItem><NumberOfExtraPalettes>0</NumberOfExtraPalettes><DepositeAmountPerUnit>0.0</DepositeAmountPerUnit><AllocationExists>0</AllocationExists><AllocationQty>0</AllocationQty><CreatedBy>574</CreatedBy></ProductList><ProductList><EnquiryGuid>30c24a1a-d9e9-4565-9e9f-930441de4331</EnquiryGuid><EnquiryProductId>0</EnquiryProductId><ItemId>2</ItemId><TotalEnquiriesCount>0</TotalEnquiriesCount><ParentItemId>0</ParentItemId><ProductCode>65105001</ProductCode><PrimaryUnitOfMeasure>Carton</PrimaryUnitOfMeasure><ProductName>Tiger 330x24C Ctn</ProductName><ParentProductCode /><ProductType>9</ProductType><ProductQuantity>116</ProductQuantity><WeightPerUnit>8.65</WeightPerUnit><AssociatedOrder>0</AssociatedOrder><ItemPricesPerUnit>285455</ItemPricesPerUnit><ItemType>32</ItemType><CurrentItemPalettesCorrectWeight>0.82857142857142863</CurrentItemPalettesCorrectWeight><CurrentItemTruckCapacityFullInTon>1.0034</CurrentItemTruckCapacityFullInTon><IsActive>1</IsActive><PriorityRating>0</PriorityRating><TotalVolume>0.82857142857142863</TotalVolume><TotalWeight>1.0034</TotalWeight><CollectionLocationCode /><PackingItemCount>0.82857142857142863</PackingItemCount><PackingItemCode>0</PackingItemCode><IsPackingItem>0</IsPackingItem><NumberOfExtraPalettes>0</NumberOfExtraPalettes><DepositeAmountPerUnit>0.0</DepositeAmountPerUnit><AllocationExists>0</AllocationExists><AllocationQty>0</AllocationQty><CreatedBy>574</CreatedBy></ProductList><ProductList><EnquiryGuid>30c24a1a-d9e9-4565-9e9f-930441de4331</EnquiryGuid><EnquiryProductId>0</EnquiryProductId><ItemId>93</ItemId><TotalEnquiriesCount>0</TotalEnquiriesCount><ParentItemId>0</ParentItemId><ProductCode>65201032</ProductCode><PrimaryUnitOfMeasure>Crate</PrimaryUnitOfMeasure><ProductName>Heineken 330x24B Crt K2 Spec</ProductName><ParentProductCode /><ProductType>9</ProductType><ProductQuantity>490</ProductQuantity><WeightPerUnit>16.49</WeightPerUnit><AssociatedOrder>0</AssociatedOrder><ItemPricesPerUnit>294545</ItemPricesPerUnit><ItemType>32</ItemType><CurrentItemPalettesCorrectWeight>7</CurrentItemPalettesCorrectWeight><CurrentItemTruckCapacityFullInTon>8.08206</CurrentItemTruckCapacityFullInTon><IsActive>1</IsActive><PriorityRating>0</PriorityRating><TotalVolume>7</TotalVolume><TotalWeight>8.08206</TotalWeight><CollectionLocationCode /><PackingItemCount>7</PackingItemCount><PackingItemCode>0</PackingItemCode><IsPackingItem>0</IsPackingItem><NumberOfExtraPalettes>0</NumberOfExtraPalettes><DepositeAmountPerUnit>2000.0</DepositeAmountPerUnit><AllocationExists>0</AllocationExists><AllocationQty>0</AllocationQty><CreatedBy>574</CreatedBy></ProductList><EnquiryId>0</EnquiryId><CompanyId>1</CompanyId><CompanyCode>1111091</CompanyCode><EnquiryAutoNumber /><EnquiryType>SO</EnquiryType><SoldTo>64</SoldTo><SoldToCode>1111091</SoldToCode><SoldToName>P188-DNTN CUONG VINH</SoldToName><ShipTo>90</ShipTo><ShipToCode>1111574</ShipToCode><ShipToName>P188-CONG TY TNHH CUONG VINH (1111574)</ShipToName><PickDateTime>2020-03-25T00:00:00</PickDateTime><EnquiryDate>2020-03-25T00:00:00</EnquiryDate><RequestDate>2020-03-26T00:00:00</RequestDate><OrderProposedETD>2020-03-26</OrderProposedETD><PreviousState>0</PreviousState><CurrentState>1</CurrentState><TruckSizeId>19</TruckSizeId><CollectionDateFromSettingValue>-1</CollectionDateFromSettingValue><PalletSpace>11.995238095238095</PalletSpace><NumberOfPalettes>12</NumberOfPalettes><TruckWeight>12.37346</TruckWeight><IsRecievingLocationCapacityExceed>1</IsRecievingLocationCapacityExceed><IsActive>1</IsActive><PromisedDate>2020-03-26T00:00:00</PromisedDate><PONumber /><TotalDepositeAmount>980000</TotalDepositeAmount><TotalDiscountAmount>0</TotalDiscountAmount><TotalOrderAmount>401076330</TotalOrderAmount><TotalAmount>401076330</TotalAmount><TotalTaxAmount>40107633</TotalTaxAmount><TotalQuantity>918</TotalQuantity><TotalPrice>442163963</TotalPrice><TotalVolume>12.37346</TotalVolume><TotalWeight>12.37346</TotalWeight><NoOfDays>1</NoOfDays><SONumber>20200325</SONumber><IsSelfCollect>false</IsSelfCollect><CarrierId>664</CarrierId><CarrierCode>21000137</CarrierCode><CarrierName>CONG TY CO PHAN BINH VINH</CarrierName><CollectionLocationId>302</CollectionLocationId><CollectionLocationCode>6410</CollectionLocationCode><CreatedBy>574</CreatedBy><TotalCount>0</TotalCount><CheckedEnquiry>false</CheckedEnquiry></Enquiry>'
@xmlDoc XML 
AS 
  BEGIN 
      SET arithabort ON 

    BEGIN --Only Varibale Declaration  
          DECLARE @TranName NVARCHAR(255) 
          DECLARE @ErrMsg NVARCHAR(2048) 
          DECLARE @ErrSeverity INT; 
          DECLARE @intPointer INT; 
		  DECLARE @EnquiryAutoNumber nvarchar(200);
		  Declare @CopyEnquiryGuid nvarchar(200)='';
	      Declare @EnquiryGuid nvarchar(200)='';
		  Declare @currentState bigint;
     END 

      SET @ErrSeverity = 15; 

      BEGIN try 
          

          EXEC Sp_xml_preparedocument 
            @intpointer output, 
            @xmlDoc 

			DECLARE @ENQUIRYIDGENERATOR BIGINT 

			SELECT
				@CopyEnquiryGuid=tmp.[CopyEnquiryGuid],
				@EnquiryGuid=tmp.[EnquiryGuid],
				@currentState=tmp.[CurrentState]
        	
				FROM OPENXML(@intpointer,'Enquiry',2)
				WITH
				(
					[EnquiryGuid] nvarchar(200),
					[CopyEnquiryGuid] nvarchar(200),
					[CurrentState] bigint 
				)tmp


-- Nimish : check for performance impact

--IF NOT EXISTS (SELECT enquiryid  FROM   enquiry with(NoLock) WHERE  Isnull(enquiryguid, '') = @EnquiryGuid) 
 --BEGIN 

		 -- Lock is required---- Shashank
		-- begin Transaction
          INSERT INTO [dbo].[enquiryidgenerated] ([value]) SELECT 'EnquiryNumber' 
          SELECT @ENQUIRYIDGENERATOR = @@IDENTITY 
        --  DELETE FROM [dbo].[enquiryidgenerated] 
		  --commit transaction
		  -- Lock ends ---- Shashank

          --DECLARE @AutoNumber NVARCHAR(100)= Cast(@ENQUIRYIDGENERATOR AS VARCHAR(15))
		  DECLARE @AutoNumber NVARCHAR(100)= CONVERT(nvarchar(100), RIGHT(REPLICATE('0', 6 - LEN(@ENQUIRYIDGENERATOR)) + CAST(@ENQUIRYIDGENERATOR AS varchar(15)), 10))

          SET @EnquiryAutoNumber='TINQ' + @AutoNumber 
		  BEGIN TRAN 
			INSERT INTO	[Enquiry]
			       (
					CompanyId,
					CompanyCode,
					CompanyName,
					EnquiryGroupNumber,
					EnquiryAutoNumber,
					EnquiryType,
					SoldTo,
					SoldToCode,
					SoldToName,
					ShipTo,
					ShipToCode,
					ShipToName,
					PickDateTime,
					EnquiryDate,
					RequestDate,
					PrimaryAddressId,
					SecondaryAddressId,
					PrimaryAddress,
					SecondaryAddress,
					OrderProposedETD,
					Remarks,
					PreviousState,
					CurrentState,
					PreviousProcess,
					CurrentProcess,
					TruckSizeId,
					PalletSpace,
					NumberOfPalettes,
					TruckWeight,
					OrderedBy,
					GratisCode,
					Province,
					Description1,
					Description2,
					IsRecievingLocationCapacityExceed,
					StockLocationId,
					CreatedBy,
					CreatedDate,
					ModifiedBy,
					ModifiedDate,
					IsActive,
					SequenceNo,
					Field1,
					Field2,
					Field3,
					Field4,
					Field5,
					Field6,
					Field7,
					Field8,
					Field9,
					Field10,
					ReturnableItemCheck,
					ReceivingLocationCapacityCheck,
					StockCheck,
					IsProcess,
					PromisedDate,
					PONumber,
					PaymentType,
					DiscountPercent,
					DiscountAmount,
					PaymentDiscountPercent,
					TotalDepositeAmount,
					TotalDiscountAmount,
					TotalAmount,
					PresellerCode,
					PresellerName,
					TotalTaxAmount,
					TotalQuantity,
					TotalPrice,
					TotalVolume,
					TotalWeight,
					NumberOfCrate,
					CollectionLocationCode,
					SONumber,
					EnquiryGuid,
					IsSelfCollect,
					CarrierId,
					CarrierCode,
					CarrierName,
					OriginalCollectionDate,
					BillToId,
					BillToCode,
					CollectionLocationId,
					CollectionLocationName,
					TruckSize
					)
					Select 
						tmp.[CompanyId],
						(select top 1 CompanyMnemonic from Company with (nolock) where CompanyId = tmp.[CompanyId]),
						(select top 1 CompanyName from Company with (nolock) where CompanyId = tmp.[CompanyId]),
						tmp.[EnquiryGroupNumber],
						@EnquiryAutoNumber,
						tmp.[EnquiryType],
						tmp.[SoldTo],
						tmp.[SoldToCode],
						tmp.[SoldToName],
						tmp.[ShipTo],
						tmp.[ShipToCode],
						tmp.[ShipToName],
						tmp.[PickDateTime],
						--tmp.[EnquiryDate],
						getdate(),
						tmp.[RequestDate],
						tmp.[PrimaryAddressId],
						tmp.[SecondaryAddressId],
						tmp.[PrimaryAddress],
						tmp.[SecondaryAddress],
						tmp.[OrderProposedETD],
						tmp.[Remarks],
						tmp.[PreviousState],
						tmp.[CurrentState],
						tmp.[PreviousProcess],
						tmp.[CurrentProcess],
						tmp.[TruckSizeId],
						tmp.[PalletSpace],
						tmp.[NumberOfPalettes],
						tmp.[TruckWeight],
						tmp.[OrderedBy],
						tmp.[GratisCode],
						tmp.[Province],
						tmp.[Description1],
						tmp.[Description2],
						tmp.[IsRecievingLocationCapacityExceed],
						tmp.[StockLocationId],
						tmp.[CreatedBy],
						GetDate(),
						NULL,
						NUll,
						tmp.[IsActive],
						tmp.[SequenceNo],
						tmp.[Field1],
						tmp.[Field2],
						tmp.[Field3],
						tmp.[Field4],
						tmp.[Field5],
						tmp.[Field6],
						tmp.[Field7],
						tmp.[Field8],
						tmp.[Field9],
						tmp.[Field10],
						tmp.[ReturnableItemCheck],
						tmp.[ReceivingLocationCapacityCheck],
						tmp.[StockCheck],
						tmp.[IsProcess],
						tmp.[PromisedDate],
						tmp.[PONumber],
						tmp.[PaymentType],
						tmp.[DiscountPercent],
						tmp.[DiscountAmount],
						tmp.[PaymentDiscountPercent],
						tmp.[TotalDepositeAmount],
						tmp.[TotalDiscountAmount],
						tmp.[TotalAmount],
						tmp.[PresellerCode],
						tmp.[PresellerName],
						tmp.[TotalTaxAmount],
						tmp.[TotalQuantity],
						tmp.[TotalPrice],
						tmp.[TotalVolume],
						tmp.[TotalWeight],
						tmp.[NumberOfCrate],
						tmp.[CollectionLocationCode],
						tmp.[SONumber],
						tmp.[EnquiryGuid],
						tmp.[IsSelfCollect],
						tmp.[CarrierId],
						tmp.[CarrierCode],
						tmp.[CarrierName],
						tmp.[OriginalCollectionDate],
						tmp.[BillToId],
						tmp.[BillToCode],
						tmp.[CollectionLocationId],
						tmp.[CollectionLocationName],
						tmp.[TruckSize]
			         FROM  OPENXML(@intpointer, 'Enquiry', 2) 
			         WITH ( 
						CompanyId bigint ,
						CompanyCode nvarchar (250),
						EnquiryGroupNumber nvarchar (250),
						EnquiryAutoNumber nvarchar (100),
						EnquiryType nvarchar (50),
						SoldTo bigint ,
						SoldToCode nvarchar (250),
						SoldToName nvarchar (250),
						ShipTo bigint ,
						ShipToCode nvarchar (250),
						ShipToName nvarchar (250),
						PickDateTime datetime ,
						EnquiryDate datetime ,
						RequestDate datetime ,
						PrimaryAddressId bigint ,
						SecondaryAddressId bigint ,
						PrimaryAddress nvarchar (500),
						SecondaryAddress nvarchar (500),
						OrderProposedETD datetime ,
						Remarks nvarchar (max),
						PreviousState bigint ,
						CurrentState bigint ,
						PreviousProcess bigint ,
						CurrentProcess bigint ,
						TruckSizeId bigint ,
						PalletSpace decimal(18,2) ,
						NumberOfPalettes decimal(18,2) ,
						TruckWeight decimal(18,2) ,
						OrderedBy bigint ,
						GratisCode nvarchar (250),
						Province nvarchar (250),
						Description1 nvarchar (250),
						Description2 nvarchar (250),
						IsRecievingLocationCapacityExceed bit ,
						StockLocationId bigint ,
						CreatedBy bigint ,
						CreatedDate datetime ,
						ModifiedBy bigint ,
						ModifiedDate datetime ,
						IsActive bit ,
						SequenceNo bigint ,
						Field1 nvarchar (500),
						Field2 nvarchar (500),
						Field3 nvarchar (500),
						Field4 nvarchar (500),
						Field5 nvarchar (500),
						Field6 nvarchar (500),
						Field7 nvarchar (500),
						Field8 nvarchar (500),
						Field9 nvarchar (500),
						Field10 nvarchar (500),
						ReturnableItemCheck int ,
						ReceivingLocationCapacityCheck int ,
						StockCheck int ,
						IsProcess bit ,
						PromisedDate datetime ,
						PONumber nvarchar (50),
						PaymentType bigint ,
						DiscountPercent decimal(18,2) ,
						DiscountAmount decimal(18,2) ,
						PaymentDiscountPercent decimal(18,2) ,
						TotalDepositeAmount decimal(18,2) ,
						TotalDiscountAmount decimal(18,2) ,
						TotalAmount decimal(18,2) ,
						PresellerCode nvarchar (100),
						PresellerName nvarchar (500),
						TotalTaxAmount decimal(18,2) ,
						TotalQuantity decimal(18,2) ,
						TotalPrice decimal(18,2) ,
						TotalVolume decimal(18,2) ,
						TotalWeight decimal(18,2) ,
						NumberOfCrate bigint ,
						CollectionLocationCode nvarchar (50),
						SONumber nvarchar (50),
						EnquiryGuid nvarchar (200),
						IsSelfCollect bit ,
						CarrierId bigint ,
						CarrierCode nvarchar (250),
						CarrierName nvarchar (250),
						OriginalCollectionDate datetime ,
						BillToId bigint ,
						BillToCode nvarchar (250),
						CollectionLocationId bigint ,
						CollectionLocationName nvarchar (200),
						TruckSize nvarchar (50) )tmp 

				DECLARE @Enquiry BIGINT 

                SET @Enquiry = @@IDENTITY 

				INSERT INTO EnquiryProduct (
			CompanyId,
			CompanyCode,
			EnquiryId,
			ProductCode,
			ProductName,
			ParentProductCode,
			ProductType,
			ProductQuantity,
			AvailableQuantity,
			DepositeAmount,
			Remarks,
			AssociatedOrder,
			EffectiveDate,
			Price,
			UnitPrice,
			TotalUnitPrice,
			CurrentStockPosition,
			CreatedBy,
			CreatedDate,
			ModifiedBy,
			ModifiedDate,
			ItemType,
			IsActive,
			NumberOfExtraPallet,
			SequenceNo,
			Field1,
			Field2,
			Field3,
			Field4,
			Field5,
			Field6,
			Field7,
			Field8,
			Field9,
			Field10,
			DiscountPercent,
			DiscountAmount,
			PaymentType,
			ReplacementParentProductId,
			IsReplaceable,
			LastStatus,
			NextStatus,
			StockLocationCode,
			StockLocationName,
			TotalVolume,
			TotalWeight,
			CollectionLocationCode,
			PackingItemCount,
			PackingItemCode,
			IsPackingItem,
			EnquiryAutoNumber,
			UOM)
			Select 
			tmp.[CompanyId],
			tmp.[CompanyCode],
			@Enquiry,
			tmp.[ProductCode],
			tmp.[ProductName],
			tmp.[ParentProductCode],
			tmp.[ProductType],
			tmp.[ProductQuantity],
			tmp.[AvailableQuantity],
			tmp.[DepositeAmount],
			tmp.[Remarks],
			tmp.[AssociatedOrder],
			tmp.[EffectiveDate],
			tmp.[Price],
			tmp.[UnitPrice],
			tmp.[TotalUnitPrice],
			tmp.[CurrentStockPosition],
			tmp.[CreatedBy],
			Getdate(),
			NULL,
			NUll,
			tmp.[ItemType],
			tmp.[IsActive],
			tmp.[NumberOfExtraPallet],
			tmp.[SequenceNo],
			tmp.[Field1],
			tmp.[Field2],
			tmp.[Field3],
			tmp.[Field4],
			tmp.[Field5],
			tmp.[Field6],
			tmp.[Field7],
			tmp.[Field8],
			tmp.[Field9],
			tmp.[Field10],
			tmp.[DiscountPercent],
			tmp.[DiscountAmount],
			tmp.[PaymentType],
			tmp.[ReplacementParentProductId],
			tmp.[IsReplaceable],
			tmp.[LastStatus],
			tmp.[NextStatus],
			tmp.[StockLocationCode],
			tmp.[StockLocationName],
			tmp.[TotalVolume],
			tmp.[TotalWeight],
			tmp.[CollectionLocationCode],
			tmp.[PackingItemCount],
			tmp.[PackingItemCode],
			tmp.[IsPackingItem],
			@EnquiryAutoNumber,
			tmp.[UOM]
          FROM   OPENXML(@intpointer, 'Enquiry/ProductList', 2) 
                    WITH ( 
						 EnquiryProductId bigint ,
						CompanyId bigint ,
						CompanyCode nvarchar (250),
						EnquiryId bigint ,
						ProductCode nvarchar (200),
						ProductName nvarchar (250),
						ParentProductCode nvarchar (200),
						ProductType nvarchar (200),
						ProductQuantity decimal(10,2) ,
						AvailableQuantity decimal(10,2) ,
						DepositeAmount decimal(18,4) ,
						Remarks nvarchar (max),
						AssociatedOrder nvarchar (100),
						EffectiveDate datetime ,
						Price decimal(18,4) ,
						UnitPrice decimal(18,4) ,
						TotalUnitPrice decimal(18,4) ,
						CurrentStockPosition bigint ,
						CreatedBy bigint ,
						CreatedDate datetime ,
						ModifiedBy bigint ,
						ModifiedDate datetime ,
						ItemType bigint ,
						IsActive bit ,
						NumberOfExtraPallet int ,
						SequenceNo bigint ,
						Field1 nvarchar (500),
						Field2 nvarchar (500),
						Field3 nvarchar (500),
						Field4 nvarchar (500),
						Field5 nvarchar (500),
						Field6 nvarchar (500),
						Field7 nvarchar (500),
						Field8 nvarchar (500),
						Field9 nvarchar (500),
						Field10 nvarchar (500),
						DiscountPercent decimal(18,2) ,
						DiscountAmount decimal(18,2) ,
						PaymentType bigint ,
						ReplacementParentProductId bigint ,
						IsReplaceable bit ,
						LastStatus bigint ,
						NextStatus bigint ,
						StockLocationCode nvarchar (250),
						StockLocationName nvarchar (250),
						TotalVolume decimal(18,2) ,
						TotalWeight decimal(18,2) ,
						CollectionLocationCode nvarchar (50),
						PackingItemCount decimal(18,2) ,
						PackingItemCode nvarchar (200),
						IsPackingItem bit ,
						EnquiryAutoNumber nvarchar (100),
						UOM nvarchar (50)
						)tmp 

                INSERT INTO [dbo].[notes] 
                            ([roleid], 
                            [objectid], 
                            [objecttype], 
                            [note], 
                            [isactive], 
                            [createdby], 
                            [createddate]) 
                SELECT tmp1.[roleid], 
                        @Enquiry, 
                        tmp1.[objecttype], 
                        tmp1.[note], 
                        1, 
                        tmp1.[createdby], 
                        Getdate() 
                FROM   OPENXML(@intpointer, 'Enquiry/NoteList', 2) 
                        WITH ([RoleId]     BIGINT, 
                                [ObjectId]   BIGINT, 
                                [ObjectType] BIGINT, 
                                [Note]       NVARCHAR(max), 
                                [CreatedBy]  BIGINT )tmp1 


			-----------------
			INSERT INTO [ReturnPakageMaterial] ([EnquiryId],
					  [ProductCode],
					  [ParentProductCode],
					  [ProductType],
					  [ProductQuantity],
					  [Price],
					  [Remarks],
					  [AssociatedOrder],
					  [ItemType],
					  [CreatedBy],
					  [CreatedDate],
					  [IsActive],
					  [SequenceNo],
					  [Field1],
					  [Field2],
					  [Field3],
					  [Field4],
					  [Field5],
					  [Field6],
					  [Field7],
					  [Field8],
					  [Field9],
					  [Field10])

						SELECT
						  @Enquiry,
						  tmp2.[ProductCode],
						  tmp2.[ParentProductCode],
						  tmp2.[ProductType],
						  tmp2.[ProductQuantity],
						  0,
						  tmp2.[Remarks],
						  tmp2.[AssociatedOrder],
						  tmp2.[ItemType],
						  1,
						  GETDATE(),
						  tmp2.[IsActive],
						  tmp2.[SequenceNo],
						  tmp2.[Field1],
						  tmp2.[Field2],
						  tmp2.[Field3],
						  tmp2.[Field4],
						  tmp2.[Field5],
						  tmp2.[Field6],
						  tmp2.[Field7],
						  tmp2.[Field8],
						  tmp2.[Field9],
						  tmp2.[Field10]
						FROM OPENXML(@intpointer, 'Enquiry/ReturnPakageMaterialList', 2)
						WITH
						(
						[EnquiryId] bigint,
						[ProductCode] nvarchar(200),
						[ParentProductCode] nvarchar(200),
						[ProductType] nvarchar(200),
						[ProductQuantity] decimal(10, 2),
						[ItemPricesPerUnit] decimal(10, 2),
						[Remarks] nvarchar,
						[AssociatedOrder] bigint,
						[ItemType] bigint,
						[CreatedBy] bigint,
						[CreatedDate] datetime,
						[IsActive] bit,
						[SequenceNo] bigint,
						[Field1] nvarchar(500),
						[Field2] nvarchar(500),
						[Field3] nvarchar(500),
						[Field4] nvarchar(500),
						[Field5] nvarchar(500),
						[Field6] nvarchar(500),
						[Field7] nvarchar(500),
						[Field8] nvarchar(500),
						[Field9] nvarchar(500),
						[Field10] nvarchar(500)
						) tmp2

-- Nimish : Check for performance impact
                SELECT @Enquiry as EnquiryId, 
                        @EnquiryAutoNumber as EnquiryAutoNumber, 
                        @currentState CurrentState, 
                        '200' AS Status 
                --FROM   enquiry WHERE  enquiryid = @Enquiry 
			commit

            IF @CopyEnquiryGuid IS NOT NULL 
                BEGIN 
                    -----------add event notfication for   order created -------- 
                    IF @currentState != 8 
                    BEGIN 
                        INSERT INTO [eventnotification] 
                                    ([eventmasterid], 
                                        [eventcode], 
                                        [objectid], 
                                        [objecttype], 
                                        [isactive], 
                                        [createddate], 
                                        [createdby])
										 
										-- Nimish : Check for performance impact 
                        SELECT (SELECT eventmasterid 
                                FROM   eventmaster with (NOLock)
                                WHERE  eventcode = 'EnquiryCreated' 
                                        AND isactive = 1), 
                                'EnquiryCreated', 
                                @Enquiry, 
                                'Enquiry', 
                                1, 
                                Getdate(), 
                                o.createdby 
                        FROM   enquiry o 
                        WHERE  o.enquiryid = @Enquiry 
                    END 

                    ------ 

                END 


            --END 
          --ELSE 
          --  BEGIN 
          --      SELECT enquiryid, 
          --             enquiryautonumber, 
          --             currentstate, 
          --             '200' AS Status 
          --      FROM   enquiry With(NoLock)
          --      WHERE  Isnull(enquiryguid, '') = @EnquiryGuid 
          --  END 
			
			

          EXEC Sp_xml_removedocument 
            @intPointer 

           
      END try 

      BEGIN catch 
           
		rollback
          SELECT @ErrMsg = Error_message(); 

          RAISERROR(@ErrMsg,@ErrSeverity,1); 
      END catch 
  END 