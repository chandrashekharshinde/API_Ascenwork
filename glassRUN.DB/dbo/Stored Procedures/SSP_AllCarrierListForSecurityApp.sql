
CREATE PROCEDURE [dbo].[SSP_AllCarrierListForSecurityApp]-- '<Json><ServicesAction>LoadAllCompanyDetailListByDropDown</ServicesAction><CompanyType>28</CompanyType><CompanyId>1368</CompanyId></Json>'(@xmlDoc XML)ASBEGINDeclare @sqlTotalCount nvarchar(4000)Declare @sql nvarchar(4000)DECLARE @intPointer INT;DECLARE @whereClause NVARCHAR(max)Declare @PageSize INTDeclare @PageIndex INTDeclare @OrderBy NVARCHAR(20)Declare @CompanyType NVARCHAR(250)Declare @CompanyValue nvarchar(250)Declare @ParentCompany NVARCHAR(250)='0'declare @TransporterVehicleRegistrationNumber  nvarchar(200) EXEC sp_xml_preparedocument @intpointer OUTPUT,@xmlDocSELECT @TransporterVehicleRegistrationNumber =RTRIM(tmp.[TransporterVehicleRegistrationNumber]),@CompanyType = tmp.[CompanyType]   FROM OPENXML(@intpointer,'Json',2)   WITH   (   TransporterVehicleRegistrationNumber nvarchar(200),   [CompanyType] nvarchar(250)   )tmp;if((RTRIM(SUBSTRING(@TransporterVehicleRegistrationNumber,0,CHARINDEX('(',@TransporterVehicleRegistrationNumber)))) != '')Begin	set @TransporterVehicleRegistrationNumber = (RTRIM(SUBSTRING(@TransporterVehicleRegistrationNumber,0,CHARINDEX('(',@TransporterVehicleRegistrationNumber))))End;WITH XMLNAMESPACES('http://james.newtonking.com/projects/json' AS json)  select cast ((  select 'true' AS [@json:Array]  , * from ( SELECT     COUNT(CompanyId) OVER () as TotalCount, [CompanyId] ,[CompanyId] as  [Id]      ,[CompanyName]      ,[CompanyMnemonic]	  ,[CompanyName]+' ('+ISNULL([CompanyMnemonic],'-')+')' as CompanyNameAndMnemonic	  ,[CompanyName]+' ('+ISNULL([CompanyMnemonic],'-')+')' as Name	  ,[CompanyType]      	FROM [dbo].Company   where IsActive=1 and CompanyType = @CompanyType and CompanyId in (select TransporterId from TransportVehicle where VehicleRegistrationNumber = @TransporterVehicleRegistrationNumber)) tmp	   FOR XML path('CompanyList'),ELEMENTS,ROOT('Json')) AS XML)END
