

CREATE PROCEDURE [dbo].[SSP_AllDriverListForSecurityApp]--'<Json><ServicesAction>LoadAllDriverListForSecurityApp</ServicesAction><CarrierId>0</CarrierId><Driver>trin</Driver></Json>'(@xmlDoc XML='<Json><CarrierId>0</CarrierId></Json>')ASBEGINDECLARE @intPointer INT;declare @CarrierId bigint=0declare @Driver nvarchar(max)=''EXEC sp_xml_preparedocument @intpointer OUTPUT,@xmlDocSELECT @CarrierId = tmp.[CarrierId],	@Driver=tmp.[Driver]	  FROM OPENXML(@intpointer,'Json',2)			WITH			(			[CarrierId] bigint,			[Driver] nvarchar(max)			)tmp;							PRINT '@CarrierId'+ CONVERT(nvarchar(250),@CarrierId)			print  '@Driver'+@Driver;	 WITH XMLNAMESPACES('http://james.newtonking.com/projects/json' AS json)SELECT CAST((SELECT top 10 'true' AS [@json:Array],l.ProfileId,	l.LoginId as DeliveryPersonnelId,	[Name],	l.UserName as UserName,	'' as [EmailId],	'' as [ContactNumber],	ISNULL(l.LicenseNumber,'-') as LicenseNumber,	l.ParentLoginId   as  ParentUser,	ReferenceId,	ReferenceType,	[RoleMasterId],	ReferenceId as TransporterId,	[PasswordSalt],	[HashedPassword],	l.UpdatedDate,	l.CreatedDate  FROM Login l    where l.IsActive = 1    and  l.LoginId in (select lu.LoginId from (Select tv.LoginId,Row_Number () OVER ( partition by [name]
     ORDER BY [name] ) as rownumber  from [Login] tv where ( tv.Name like '%'+@Driver+'%' or @Driver='')      and tv.IsActive=1     and tv.RoleMasterId in (select RoleMasterId from RoleMaster where RoleName='Driver')    and (tv.ReferenceId=@CarrierId or @CarrierId=0)   and tv.LoginId not in (select DriverId from TruckInDeatils where TruckOutDataTime is null)      ) as lu where rownumber=1)  -- and (l.Name like '%'+@Driver+'%' or @Driver='')       order by name asc	FOR XML path('ProfileList'),ELEMENTS,ROOT('Json')) AS XML)END
