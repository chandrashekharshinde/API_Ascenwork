CREATE PROCEDURE [dbo].[ISP_CreateOrderRun] --'<Json><Enquiry><rownumber>1</rownumber><TotalCount>1</TotalCount><TripCost>0</TripCost><TripRevenue>0</TripRevenue><TripProfit>0</TripProfit><TripProfitPerCent>0.00</TripProfitPerCent><BillingStatus /><BillingCreditedAmount /><BillingCreditedAmountStatus /><BillingCreditedAmountDate /><BalanceAmount>0.00</BalanceAmount><BalAmtStatus>Trip Cost Not Assign</BalAmtStatus><BalanceAmountDate>2019-10-13T11:25:38.387</BalanceAmountDate><OrderId>12214</OrderId><EnquiryId>4317</EnquiryId><OrderType>SO</OrderType><ModifiedDate>2019-10-09T15:21:49.817</ModifiedDate><OrderNumber>000038</OrderNumber><HoldStatus>-</HoldStatus><TotalPrice>54.384.132,00 ₫</TotalPrice><SalesOrderNumber>353999010</SalesOrderNumber><SOGratisNumber>353999010</SOGratisNumber><PurchaseOrderNumber /><ProposedShift>1</ProposedShift><Shift /><ProposedTimeOfAction>1900-01-01T00:00:00</ProposedTimeOfAction><StatusForChangeInPickShift>0</StatusForChangeInPickShift><OrderDate>2019-10-09T15:21:49.817</OrderDate><DeliveryLocationName>BK6-PHAM NGOC HUNG</DeliveryLocationName><LocationName>BK6-PHAM NGOC HUNG</LocationName><DeliveryLocation>18111176</DeliveryLocation><SupplierName>HEINEKEN VBL</SupplierName><SupplierCode>00064</SupplierCode><CompanyName>BK6-PHAM NGOC HUNG</CompanyName><ShortCompanyName>BK6</ShortCompanyName><CompanyMnemonic>18111176</CompanyMnemonic><UserName>18111176A</UserName><ExpectedTimeOfDelivery>2019-09-18T00:00:00</ExpectedTimeOfDelivery><RequestDate>2019-09-18T00:00:00</RequestDate><ReceivedCapacityPalettes>-4</ReceivedCapacityPalettes><Capacity>0</Capacity><IsRPMPresent>0</IsRPMPresent><EnquiryAutoNumber>INQ000038</EnquiryAutoNumber><OrderedBy>4412</OrderedBy><CarrierNumberValue>CONG TY TNHH MTV HT VINA</CarrierNumberValue><Field1 /><CurrentState>525</CurrentState><Status>Order approved</Status><Class>#e2c703</Class><ShipTo>1255</ShipTo><OrderCompanyId>1</OrderCompanyId><SoldTo>40</SoldTo><ReceivedCapacityPalettesCheck>0</ReceivedCapacityPalettesCheck><BranchPlantName>VBB - kho Van Tao</BranchPlantName><BranchPlantCode>6460</BranchPlantCode><DeliveryLocationBranchName>VBB - kho Van Tao</DeliveryLocationBranchName><RPMValue>0</RPMValue><EmptiesLimit>0</EmptiesLimit><ActualEmpties>0</ActualEmpties><TruckCapacityWeight>5.00</TruckCapacityWeight><TruckSizeId>46</TruckSizeId><TruckSize>H05</TruckSize><DriverName>Bế Đình Tuyển</DriverName><IsCompleted /><EnquiryDate>2019-09-17T09:34:40.61</EnquiryDate><IsLate>1</IsLate><ProfileId>0</ProfileId><TruckInPlateNumber /><TruckOutPlateNumber /><TruckInDateTime>1900-01-01T00:00:00</TruckInDateTime><TruckOutDateTime>1900-01-01T00:00:00</TruckOutDateTime><CarrierNumber>1042</CarrierNumber><CarrierCode>21001641</CarrierCode><ExpectedShift /><ExpectedTimeOfAction>1900-01-01T00:00:00</ExpectedTimeOfAction><DeliveryPersonnelId>5315</DeliveryPersonnelId><PickDateTime>2019-09-17T00:00:00</PickDateTime><ExpectedTimeOfDeliveryFromOM>1900-01-01T00:00:00</ExpectedTimeOfDeliveryFromOM><PickDateTimeFromOM>1900-01-01T00:00:00</PickDateTimeFromOM><ExpectedTimeOfDeliveryValue>2019-09-18T00:00:00</ExpectedTimeOfDeliveryValue><PickDateTimeValue>2019-09-17T00:00:00</PickDateTimeValue><IsSelfCollect>0</IsSelfCollect><TruckInDeatilsId>0</TruckInDeatilsId><TruckInOrderId>0</TruckInOrderId><ShipToCode>18111176</ShipToCode><OrderProductList><OrderProductId>401</OrderProductId><OrderId>12214</OrderId><ProductCode>55909001</ProductCode><ProductType>9</ProductType><ItemType>0</ItemType><ItemName>Pallet - Wooden MT</ItemName><ProductQuantity>4</ProductQuantity><ItemPricesPerUnit>0</ItemPricesPerUnit><ItemPrices>0</ItemPrices><DepositeAmountPerUnit>0</DepositeAmountPerUnit><ItemTotalDepositeAmount>0</ItemTotalDepositeAmount><UOM>Each</UOM><ItemTax>10</ItemTax><AssociatedOrder>0</AssociatedOrder><UsedQuantityInOrder>0</UsedQuantityInOrder><ProductAvailableQuantity>0</ProductAvailableQuantity></OrderProductList><OrderProductList><OrderProductId>402</OrderProductId><OrderId>12214</OrderId><ProductCode>65102011</ProductCode><ProductType>9</ProductType><ItemType>32</ItemType><ItemName>Tiger 640x12B Crt Gold</ItemName><ProductQuantity>264</ProductQuantity><ItemPricesPerUnit>185455</ItemPricesPerUnit><ItemPrices>48960120</ItemPrices><DepositeAmountPerUnit>2000</DepositeAmountPerUnit><ItemTotalDepositeAmount>528000</ItemTotalDepositeAmount><UOM>Crate</UOM><ItemTax>10</ItemTax><AssociatedOrder>0</AssociatedOrder><UsedQuantityInOrder>0</UsedQuantityInOrder><ProductAvailableQuantity>0</ProductAvailableQuantity></OrderProductList><CheckedEnquiry>true</CheckedEnquiry><ProposedShiftForCheck /><ExpectedTimeOfDeliveryForCheck>2019-09-18T00:00:00</ExpectedTimeOfDeliveryForCheck><PickDateTimeForCheck>2019-09-17T00:00:00</PickDateTimeForCheck><IsShowAssignDriverBtn>true</IsShowAssignDriverBtn><IsEditPromiseDatePickUpDate>true</IsEditPromiseDatePickUpDate><IsShowDeliveryButton>false</IsShowDeliveryButton><showPlateNumberDropDown>true</showPlateNumberDropDown><ShowPlateNumberListBox>false</ShowPlateNumberListBox><PlateNumber>14C14828</PlateNumber><PlateNumberData>14C14828</PlateNumberData><SelectedPlateNumber>14C14828</SelectedPlateNumber><DeliveryPersonnelName>Bế Đình Tuyển</DeliveryPersonnelName><showDriverDropDown>true</showDriverDropDown><ShowDriverListBox>false</ShowDriverListBox><showShiftDropDown>true</showShiftDropDown><UserId>5027</UserId><CreatedBy>5027</CreatedBy><ServicesAction>GetLoadNumberFromThirthParty</ServicesAction></Enquiry><OrderProductMovement><OrderMovementGuid>5d07f5af-fc38-4bfb-ab62-e50587d2dc3f</OrderMovementGuid><ProductCode>55909001</ProductCode><OrderId>12214</OrderId><ProductQuantity>4</ProductQuantity><OrderProductId>401</OrderProductId></OrderProductMovement><OrderProductMovement><OrderMovementGuid>5d07f5af-fc38-4bfb-ab62-e50587d2dc3f</OrderMovementGuid><ProductCode>65102011</ProductCode><OrderId>12214</OrderId><ProductQuantity>264</ProductQuantity><OrderProductId>402</OrderProductId></OrderProductMovement><OrderProductMovement><OrderMovementGuid>020cb524-df85-49f0-8e8f-1e06e978b2c8</OrderMovementGuid><ProductCode>55909001</ProductCode><OrderId>12214</OrderId><ProductQuantity>4</ProductQuantity><OrderProductId>401</OrderProductId></OrderProductMovement><OrderProductMovement><OrderMovementGuid>020cb524-df85-49f0-8e8f-1e06e978b2c8</OrderMovementGuid><ProductCode>65102011</ProductCode><OrderId>12214</OrderId><ProductQuantity>264</ProductQuantity><OrderProductId>402</OrderProductId></OrderProductMovement><OrderMovement><FromBranchPlantCode>6460</FromBranchPlantCode><OrderMovementGuid>5d07f5af-fc38-4bfb-ab62-e50587d2dc3f</OrderMovementGuid><LocationType>1</LocationType></OrderMovement><OrderMovement><FromBranchPlantCode>6460</FromBranchPlantCode><OrderMovementGuid>020cb524-df85-49f0-8e8f-1e06e978b2c8</OrderMovementGuid><LocationType>2</LocationType></OrderMovement></Json>' 
	@xmlDoc XML
AS
BEGIN
	SET ARITHABORT ON

	DECLARE @TranName NVARCHAR(255)
	DECLARE @ErrMsg NVARCHAR(2048)
	DECLARE @ErrSeverity INT;
	DECLARE @intPointer INT;

	SET @ErrSeverity = 15;

	BEGIN TRY
		DECLARE @OrderId BIGINT
		DECLARE @SalesOrderNumber NVARCHAR(150)
		DECLARE @PraposedTimeOfAction DATETIME
		DECLARE @PraposedShift NVARCHAR(150)
		DECLARE @locationType NVARCHAR(150)
		DECLARE @expectedTimeOfDelivery NVARCHAR(150)
		DECLARE @pickDateTime NVARCHAR(150)
		DECLARE @UserId BIGINT

		EXEC sp_xml_preparedocument @intpointer OUTPUT
			,@xmlDoc

		SELECT @OrderId = tmp.[OrderId]
			,@SalesOrderNumber = tmp.[SalesOrderNumber]
			,@PraposedShift = tmp.[PraposedShift]
			,@locationType = tmp.[LocationType]
			,@UserId = tmp.[UserId]
			,@expectedTimeOfDelivery = tmp.ExpectedTimeOfDelivery
			,@pickDateTime = tmp.PickDateTime
		FROM OPENXML(@intpointer, 'Json/Enquiry', 2) WITH (
				[OrderId] BIGINT
				,[SalesOrderNumber] NVARCHAR(150)
				,[PraposedShift] NVARCHAR(150)
				,[LocationType] NVARCHAR(150)
				,[UserId] BIGINT
				,ExpectedTimeOfDelivery NVARCHAR(150)
				,PickDateTime NVARCHAR(150)
				) tmp
                print 'xml table created'



		
			SELECT * INTO #tmpOrderMovement
			FROM OPENXML(@intpointer,'Json/OrderMovement',2)
			WITH
			(
			[FromBranchPlantCode] nvarchar(500),
			[OrderMovementGuid] nvarchar(500),
			[LocationType] bigint
			)tmp


			SELECT * INTO #tmpOrderProductMovement
			FROM OPENXML(@intpointer,'Json/OrderProductMovement',2)
			WITH
			(
			[FromBranchPlantCode] nvarchar(500),
			[ProductCode] nvarchar(500),
			[OrderMovementGuid] nvarchar(500),
			[OrderId] bigint,
			[ProductQuantity] decimal(18, 2),
			[OrderProductId] bigint
			)tmp
Select * from #tmpOrderMovement
Select * from #tmpOrderProductMovement 
		DECLARE @orderMovementId BIGINT
		DECLARE @IsPresentOrNot BIGINT
		DECLARE @PlanNumber NVARCHAR(max)
		DECLARE @GroupNumber NVARCHAR(max)

		SELECT @PlanNumber = 'PL' + cast(@OrderId as nvarchar)

		SET @IsPresentOrNot = (
				SELECT Count(OrderMovementId)
				FROM OrderMovement
				WHERE OrderId = @OrderId
				)
                print @IsPresentOrNot
		IF @IsPresentOrNot = 0
		BEGIN
			SELECT @GroupNumber = 'C' + convert(NVARCHAR(max), @OrderId)

			-------------------------------------------------Collection--------------------------------------
			INSERT INTO [dbo].[orderMovement] (
				[OrderId]
				,[Location]
				,LocationType
				,PraposedTimeOfAction
				,ExpectedTimeOfAction
				,PraposedShift
				,GroupName
				,PlanNumber
				,OrderMovmentGuid
				,[IsActive]
				,[CreatedBy]
				,[CreatedDate]
				)
			SELECT @OrderId
				,(select top 1 LocationId From [Location]  where LocationCode=tmp.[FromBranchPlantCode])
				,1
				,cast(@pickDateTime as datetime)
				,cast(@pickDateTime as datetime)
				,@PraposedShift
				,@GroupNumber
				,@PlanNumber
				,tmp.[OrderMovementGuid]
				,1
				,@UserId
				,getdate()
			From #tmpOrderMovement tmp where tmp.[LocationType]=1

			INSERT INTO [dbo].OrderProductMovement (
					OrderId
					,OrderProductId
					,OrderMovementId
					,PlannedQuantity
					,ActualQuantity
					,[IsActive]
					,[CreatedBy]
					,[CreatedDate]
					)
				SELECT @orderId
					,optmp.[OrderProductId]
					,(Select top 1 OrderMovementId from OrderMovement om where isnull(om.OrderMovmentGuid,'-')=optmp.[OrderMovementGuid])
					,optmp.[ProductQuantity]
					,NULL
					,1
					,1
					,GETDATE()
				FROM #tmpOrderProductMovement optmp where optmp.[OrderMovementGuid] in (Select tmp.[OrderMovementGuid] From #tmpOrderMovement tmp where tmp.[LocationType]=1)

			SELECT @GroupNumber = 'D' + convert(NVARCHAR(max), @OrderId)

			------------------------------------------------------Delivery---------------------------------------------------------------------
			DECLARE @shipto BIGINT = 0

			SELECT @shipto = ShipTo
			FROM [order]
			WHERE OrderId = @OrderId

				INSERT INTO [dbo].[orderMovement] (
				[OrderId]
				,[Location]
				,LocationType
				,PraposedTimeOfAction
				,ExpectedTimeOfAction
				,PraposedShift
				,GroupName
				,PlanNumber
				,OrderMovmentGuid
				,[IsActive]
				,[CreatedBy]
				,[CreatedDate]
				)
			SELECT @OrderId
				,@shipto
				,2
				,cast(@pickDateTime as datetime)
				,cast(@pickDateTime as datetime)
				,@PraposedShift
				,@GroupNumber
				,@PlanNumber
				,tmp.[OrderMovementGuid]
				,1
				,@UserId
				,getdate()
			From #tmpOrderMovement tmp where tmp.[LocationType]=2



			SELECT @orderMovementId = @@IDENTITY
            print 'done3'

					INSERT INTO [dbo].OrderProductMovement (
					OrderId
					,OrderProductId
					,OrderMovementId
					,PlannedQuantity
					,ActualQuantity
					,[IsActive]
					,[CreatedBy]
					,[CreatedDate]
					)
				SELECT @orderId
					,optmp.[OrderProductId]
					,(Select top 1 OrderMovementId from OrderMovement om where isnull(om.OrderMovmentGuid,'-')=optmp.[OrderMovementGuid])
					,optmp.[ProductQuantity]
					,NULL
					,1
					,1
					,GETDATE()
				FROM #tmpOrderProductMovement optmp where optmp.[OrderMovementGuid] in (Select tmp.[OrderMovementGuid] From #tmpOrderMovement tmp where tmp.[LocationType]=2)



		END

		BEGIN
			PRINT 'done5'

			UPDATE [Order]
			SET Field3 = @PraposedTimeOfAction
			WHERE OrderId = @OrderId
		END

		EXEC sp_xml_removedocument @intPointer
	END TRY

	BEGIN CATCH
		SELECT @ErrMsg = ERROR_MESSAGE();

		RAISERROR (
				@ErrMsg
				,@ErrSeverity
				,1
				);
                print error_line();
		RETURN;
	END CATCH
END
