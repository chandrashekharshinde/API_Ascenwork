CREATE PROCEDURE [dbo].[SSP_GetAllTempSTOrderList] --'<Json><STOrderList><OrderGroupCode>1</OrderGroupCode><FromBranchPlant>0710</FromBranchPlant><ToBranchPlant>0711</ToBranchPlant><TruckSize>H27</TruckSize><RequestDate>2018-02-13T00:00:00</RequestDate><ItemCode>65105011</ItemCode><UOM>Carton</UOM><Quantity>2640</Quantity><Carrier>2100736</Carrier><Column9 /><Column10 /><Column11 /><Column12 /></STOrderList><STOrderList><OrderGroupCode>2</OrderGroupCode><FromBranchPlant>0710</FromBranchPlant><ToBranchPlant>0711</ToBranchPlant><TruckSize>H22</TruckSize><RequestDate>2018-02-13T00:00:00</RequestDate><ItemCode>65105011</ItemCode><UOM>Carton</UOM><Quantity>2160</Quantity><Carrier>2102393</Carrier><Column9 /><Column10 /><Column11 /><Column12 /></STOrderList><STOrderList><OrderGroupCode>3</OrderGroupCode><FromBranchPlant>0710</FromBranchPlant><ToBranchPlant>0711</ToBranchPlant><TruckSize>H22</TruckSize><RequestDate>2018-02-13T00:00:00</RequestDate><ItemCode>65105011</ItemCode><UOM>Carton</UOM><Quantity>2160</Quantity><Carrier>2102393</Carrier><Column9 /><Column10 /><Column11 /><Column12 /></STOrderList><STOrderList><OrderGroupCode>4</OrderGroupCode><FromBranchPlant>0710</FromBranchPlant><ToBranchPlant>0711</ToBranchPlant><TruckSize>H22</TruckSize><RequestDate>2018-02-13T00:00:00</RequestDate><ItemCode>65105011</ItemCode><UOM>Carton</UOM><Quantity>2160</Quantity><Carrier>2102393</Carrier><Column9 /><Column10 /><Column11 /><Column12 /></STOrderList><STOrderList><OrderGroupCode>5</OrderGroupCode><FromBranchPlant>0710</FromBranchPlant><ToBranchPlant>0711</ToBranchPlant><TruckSize>H22</TruckSize><RequestDate>2018-02-13T00:00:00</RequestDate><ItemCode>65105011</ItemCode><UOM>Carton</UOM><Quantity>2160</Quantity><Carrier>2102393</Carrier><Column9 /><Column10 /><Column11 /><Column12 /></STOrderList><STOrderList><OrderGroupCode>6</OrderGroupCode><FromBranchPlant>0710</FromBranchPlant><ToBranchPlant>0725</ToBranchPlant><TruckSize>H22</TruckSize><RequestDate>2018-02-13T00:00:00</RequestDate><ItemCode>65102011</ItemCode><UOM>Crts</UOM><Quantity>1188</Quantity><Carrier>2143951</Carrier><Column9 /><Column10 /><Column11 /><Column12 /></STOrderList><STOrderList><OrderGroupCode>7</OrderGroupCode><FromBranchPlant>0710</FromBranchPlant><ToBranchPlant>0725</ToBranchPlant><TruckSize>H22</TruckSize><RequestDate>2018-02-13T00:00:00</RequestDate><ItemCode>65205041</ItemCode><UOM>Carton</UOM><Quantity>2340</Quantity><Carrier>2100736</Carrier><Column9 /><Column10 /><Column11 /><Column12 /></STOrderList><STOrderList><OrderGroupCode>8</OrderGroupCode><FromBranchPlant>0710</FromBranchPlant><ToBranchPlant>0726</ToBranchPlant><TruckSize>H22</TruckSize><RequestDate>2018-02-13T00:00:00</RequestDate><ItemCode>65205041</ItemCode><UOM>Carton</UOM><Quantity>2340</Quantity><Carrier>2101438</Carrier><Column9 /><Column10 /><Column11 /><Column12 /></STOrderList><STOrderList><OrderGroupCode>9</OrderGroupCode><FromBranchPlant>0710</FromBranchPlant><ToBranchPlant>0726</ToBranchPlant><TruckSize>H22</TruckSize><RequestDate>2018-02-13T00:00:00</RequestDate><ItemCode>65205041</ItemCode><UOM>Carton</UOM><Quantity>2340</Quantity><Carrier>2100736</Carrier><Column9 /><Column10 /><Column11 /><Column12 /></STOrderList><STOrderList><OrderGroupCode>10</OrderGroupCode><FromBranchPlant>0710</FromBranchPlant><ToBranchPlant>0726</ToBranchPlant><TruckSize>H27</TruckSize><RequestDate>2018-02-13T00:00:00</RequestDate><ItemCode>65102011</ItemCode><UOM>Crts</UOM><Quantity>1452</Quantity><Carrier>2121003</Carrier><Column9 /><Column10 /><Column11 /><Column12 /></STOrderList><STOrderList><OrderGroupCode>11</OrderGroupCode><FromBranchPlant>0710</FromBranchPlant><ToBranchPlant>0714</ToBranchPlant><TruckSize>H27</TruckSize><RequestDate>2018-02-13T00:00:00</RequestDate><ItemCode>65101021</ItemCode><UOM>Crts</UOM><Quantity>700</Quantity><Carrier>2100736</Carrier><Column9 /><Column10 /><Column11 /><Column12 /></STOrderList><STOrderList><OrderGroupCode>11</OrderGroupCode><FromBranchPlant>0710</FromBranchPlant><ToBranchPlant>0714</ToBranchPlant><TruckSize>H27</TruckSize><RequestDate>2018-02-13T00:00:00</RequestDate><ItemCode>65102011</ItemCode><UOM>Crts</UOM><Quantity>132</Quantity><Carrier>2100736</Carrier><Column9 /><Column10 /><Column11 /><Column12 /></STOrderList><STOrderList><OrderGroupCode>11</OrderGroupCode><FromBranchPlant>0710</FromBranchPlant><ToBranchPlant>0714</ToBranchPlant><TruckSize>H27</TruckSize><RequestDate>2018-02-13T00:00:00</RequestDate><ItemCode>65101104</ItemCode><UOM>Crts</UOM><Quantity>700</Quantity><Carrier>2100736</Carrier><Column9 /><Column10 /><Column11 /><Column12 /></STOrderList><STOrderList><OrderGroupCode /><FromBranchPlant /><ToBranchPlant /><TruckSize /><RequestDate /><ItemCode /><UOM /><Quantity /><Carrier /><Column9 /><Column10 /><Column11 /><Column12 /></STOrderList><STOrderList><OrderGroupCode /><FromBranchPlant /><ToBranchPlant /><TruckSize /><RequestDate /><ItemCode /><UOM /><Quantity /><Carrier /><Column9 /><Column10 /><Column11 /><Column12 /></STOrderList><STOrderList><OrderGroupCode /><FromBranchPlant /><ToBranchPlant /><TruckSize /><RequestDate /><ItemCode /><UOM /><Quantity /><Carrier /><Column9 /><Column10 /><Column11 /><Column12 /></STOrderList><STOrderList><OrderGroupCode /><FromBranchPlant /><ToBranchPlant /><TruckSize /><RequestDate /><ItemCode /><UOM /><Quantity /><Carrier /><Column9 /><Column10 /><Column11 /><Column12 /></STOrderList><STOrderList><OrderGroupCode /><FromBranchPlant /><ToBranchPlant /><TruckSize /><RequestDate /><ItemCode /><UOM /><Quantity /><Carrier /><Column9 /><Column10 /><Column11 /><Column12 /></STOrderList><STOrderList><OrderGroupCode /><FromBranchPlant /><ToBranchPlant /><TruckSize /><RequestDate /><ItemCode /><UOM /><Quantity /><Carrier /><Column9 /><Column10 /><Column11 /><Column12 /></STOrderList><STOrderList><OrderGroupCode /><FromBranchPlant /><ToBranchPlant /><TruckSize /><RequestDate /><ItemCode /><UOM /><Quantity /><Carrier /><Column9 /><Column10 /><Column11 /><Column12 /></STOrderList><STOrderList><OrderGroupCode /><FromBranchPlant /><ToBranchPlant /><TruckSize /><RequestDate /><ItemCode /><UOM /><Quantity /><Carrier /><Column9 /><Column10 /><Column11 /><Column12 /></STOrderList><STOrderList><OrderGroupCode /><FromBranchPlant /><ToBranchPlant /><TruckSize /><RequestDate /><ItemCode /><UOM /><Quantity /><Carrier /><Column9 /><Column10 /><Column11 /><Column12 /></STOrderList><STOrderList><OrderGroupCode /><FromBranchPlant /><ToBranchPlant /><TruckSize /><RequestDate /><ItemCode /><UOM /><Quantity /><Carrier /><Column9 /><Column10 /><Column11 /><Column12 /></STOrderList></Json>'
@xmlDoc xml 
AS 
 BEGIN 
 SET ARITHABORT ON 
 DECLARE @TranName NVARCHAR(255) 
 DECLARE @ErrMsg NVARCHAR(2048) 
 DECLARE @ErrSeverity INT; 
 DECLARE @intPointer INT; 
 SET @ErrSeverity = 15; 

  BEGIN TRY
   EXEC sp_xml_preparedocument @intpointer OUTPUT,@xmlDoc


    Select * into #tempSTOrder
 FROM OPENXML(@intpointer,'Json/STOrderList',2)
        WITH
        (
		[OrderGroupCode] nvarchar(200),
			--[ShipTo]	bigint,
			[ToBranchPlant]	nvarchar(50),
			FromBranchPlant nvarchar(50),
			Carrier nvarchar(50),
			--[TruckSizeId]	bigint,
			[TruckSize]	nvarchar(50),
			--[ItemId]	bigint,
			[ItemCode] nvarchar(50),
			[Quantity]	decimal,
			--[UOM] bigint,
			[UOM] nvarchar(100),
			[RequestDate]	datetime
			
        )tmp



	declare @totalCount int=0
	declare @groupCount int=0
	set @totalCount=(select Count(*) from (select distinct [OrderGroupCode],ToBranchPlant,FromBranchPlant,Carrier,[TruckSize] from #tempSTOrder) as dfdf)
	set @groupCount=(select Count(*) from (select distinct [OrderGroupCode] from #tempSTOrder) as dfdf)

	If @totalCount!=@groupCount
	begin
	Select 'Group Code Not Match' as Remark
	end
	else
	Begin

   select 	
   tmp.OrderGroupCode,
	isnull(d.DeliveryLocationId,0) as ToBranchPlantId,
	isnull(branch.DeliveryLocationId,0) as FromBranchPlantId,
	tmp.[ToBranchPlant],
	tmp.FromBranchPlant,
	isnull(d.DeliveryLocationName,'') as ToBranchPlantName,
	isnull(branch.DeliveryLocationName,'')  as FromBranchPlantName,
	isnull(t.TruckSizeId,0) as TruckSizeId,
	tmp.Carrier,
	isnull(t.TruckCapacityPalettes,0) as TruckCapacityPalettes,
	isnull(t.TruckCapacityWeight,0) as TruckCapacityWeight,
	isnull([dbo].[fn_GetWeightPerUnitOfItem](I.ItemId),0) as ItemWeightPerUnit,
	isnull((ConversionFactor),0) as ConversionFactor,
	(case isnull(ConversionFactor,0) when 0 then 0 else (isnull(tmp.Quantity,0)/isnull(ConversionFactor,1)) end) as TotalRequiredPalettes,
	(isnull(tmp.Quantity,0)*isnull([dbo].[fn_GetWeightPerUnitOfItem](I.ItemId),0)) TotalRequiredWeight,
	(select top 1 ISNULL(Convert(decimal(18,2),s.SettingValue),0) from SettingMaster s where s.SettingParameter='TruckBufferWeight' ) as TruckBufferWeight,
	(select top 1 ISNULL(Convert(decimal(18,2),s.SettingValue),0) from SettingMaster s where s.SettingParameter='TruckExceedBufferWeight' ) as TruckExceedBufferWeight,
	(select top 1 ISNULL(Convert(decimal(18,2),s.SettingValue),0) from SettingMaster s where s.SettingParameter='PalettesExceedBufferWeight' ) as PalettesExceedBufferWeight,
	(select top 1 ISNULL(Convert(decimal(18,2),s.SettingValue),0) from SettingMaster s where s.SettingParameter='PalettesWeight' ) as PalettesWeight,
	tmp.[TruckSize],
	isnull(i.ItemId,0)as ItemId,
	isnull(i.ItemName,0)as ItemName,
	tmp.ItemCode,
	(select top 1 ItemShortCode from item where ItemCode = tmp.ItemCode) as ItemShortCode,
	tmp.Quantity,
	l.LookUpId as UOM,	 
	(SELECT [dbo].[fn_GetPriceOfItem] (i.[ItemId],d.CompanyID)) as Amount,
	c.CompanyId,
	(select CarrierNumber from Route where CarrierNumber=c.CompanyId and DestinationId=isnull(d.DeliveryLocationId,0) and OriginId=isnull(branch.DeliveryLocationId,0) and TruckSizeId=isnull(t.TruckSizeId,0)) as CarrierCompanyId,
	
tmp.[RequestDate],
i.ProductType,
'' as Remark
	
    --into #tmpGratisOrderList
    FROM OPENXML(@intpointer,'Json/STOrderList',2)
        WITH
        (
		[OrderGroupCode] nvarchar(200),
			--[ShipTo]	bigint,
			[ToBranchPlant]	nvarchar(50),
			FromBranchPlant nvarchar(50),
			Carrier nvarchar(50),
			--[TruckSizeId]	bigint,
			[TruckSize]	nvarchar(50),
			--[ItemId]	bigint,
			[ItemCode] nvarchar(50),
			[Quantity]	decimal,
			--[UOM] bigint,
			[UOM] nvarchar(100),
			[RequestDate]	datetime
			
        )tmp
		left join TruckSize t on t.TruckSize=tmp.[TruckSize]  and t.IsActive=1
		left join Item i on i.ItemCode=tmp.[ItemCode] and i.IsActive=1
		left join DeliveryLocation d on d.DeliveryLocationCode=tmp.[ToBranchPlant] and d.IsActive=1 and d.LocationType=21 --distributer or ship to
		left join DeliveryLocation branch on branch.DeliveryLocationCode=tmp.FromBranchPlant and branch.IsActive=1 and branch.LocationType=21
		left join Company c on c.CompanyMnemonic=tmp.Carrier and c.CompanyType=28
		left join [LookUp] l on l.Code=tmp.[UOM] and l.IsActive=1
		left join UnitOfMeasure umo on I.ItemId=umo.ItemId  WHERE I.IsActive =1 and I.PrimaryUnitOfMeasure=umo.UOM and umo.RelatedUOM=16
end
		
    exec sp_xml_removedocument @intPointer  
    END TRY
    BEGIN CATCH
    SELECT @ErrMsg = ERROR_MESSAGE(); 
    RAISERROR(@ErrMsg, @ErrSeverity, 1); 
    RETURN; 
    END CATCH
END
